{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/packages/accounts-password/password_tests.js","filenameRelative":"/packages/accounts-password/password_tests.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":false,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/packages/accounts-password/password_tests.js.map","sourceFileName":"/packages/accounts-password/password_tests.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"password_tests"},"ignored":false,"code":"Accounts._noConnectionCloseDelayForTest = true;\n\nif (Meteor.isServer) {\n  Accounts.removeDefaultRateLimit();\n\n  Meteor.methods({\n    getResetToken: function () {\n      function getResetToken() {\n        var token = Meteor.users.findOne(this.userId).services.password.reset;\n        return token;\n      }\n\n      return getResetToken;\n    }(),\n    addSkipCaseInsensitiveChecksForTest: function () {\n      function addSkipCaseInsensitiveChecksForTest(value) {\n        Accounts._skipCaseInsensitiveChecksForTest[value] = true;\n      }\n\n      return addSkipCaseInsensitiveChecksForTest;\n    }(),\n    removeSkipCaseInsensitiveChecksForTest: function () {\n      function removeSkipCaseInsensitiveChecksForTest(value) {\n        delete Accounts._skipCaseInsensitiveChecksForTest[value];\n      }\n\n      return removeSkipCaseInsensitiveChecksForTest;\n    }(),\n    countUsersOnServer: function () {\n      function countUsersOnServer(query) {\n        return Meteor.users.find(query).count();\n      }\n\n      return countUsersOnServer;\n    }()\n  });\n}\n\nif (Meteor.isClient) (function () {\n\n  // XXX note, only one test can do login/logout things at once! for\n  // now, that is this test.\n\n  Accounts._isolateLoginTokenForTest();\n\n  var addSkipCaseInsensitiveChecksForTest = function addSkipCaseInsensitiveChecksForTest(value, test, expect) {\n    Meteor.call('addSkipCaseInsensitiveChecksForTest', value);\n  };\n\n  var removeSkipCaseInsensitiveChecksForTest = function removeSkipCaseInsensitiveChecksForTest(value, test, expect) {\n    Meteor.call('removeSkipCaseInsensitiveChecksForTest', value);\n  };\n\n  var createUserStep = function createUserStep(test, expect) {\n    // Hack because Tinytest does not clean the database between tests/runs\n    this.randomSuffix = Random.id(10);\n    this.username = 'AdaLovelace' + this.randomSuffix;\n    this.email = \"Ada-intercept@lovelace.com\" + this.randomSuffix;\n    this.password = 'password';\n    Accounts.createUser({ username: this.username, email: this.email, password: this.password }, loggedInAs(this.username, test, expect));\n  };\n  var logoutStep = function logoutStep(test, expect) {\n    Meteor.logout(expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n      test.equal(Meteor.user(), null);\n    }));\n  };\n  var loggedInAs = function loggedInAs(someUsername, test, expect) {\n    return expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n      test.equal(Meteor.userId() && Meteor.user().username, someUsername);\n    });\n  };\n  var loggedInUserHasEmail = function loggedInUserHasEmail(someEmail, test, expect) {\n    return expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n      var user = Meteor.user();\n      test.isTrue(user && _.some(user.emails, function (email) {\n        return email.address === someEmail;\n      }));\n    });\n  };\n  var expectError = function expectError(expectedError, test, expect) {\n    return expect(function (actualError) {\n      test.equal(actualError && actualError.error, expectedError.error);\n      test.equal(actualError && actualError.reason, expectedError.reason);\n    });\n  };\n  var expectUserNotFound = function expectUserNotFound(test, expect) {\n    return expectError(new Meteor.Error(403, \"User not found\"), test, expect);\n  };\n  var waitForLoggedOutStep = function waitForLoggedOutStep(test, expect) {\n    pollUntil(expect, function () {\n      return Meteor.userId() === null;\n    }, 10 * 1000, 100);\n  };\n  var invalidateLoginsStep = function invalidateLoginsStep(test, expect) {\n    Meteor.call(\"testInvalidateLogins\", 'fail', expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n    }));\n  };\n  var hideActualLoginErrorStep = function hideActualLoginErrorStep(test, expect) {\n    Meteor.call(\"testInvalidateLogins\", 'hide', expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n    }));\n  };\n  var validateLoginsStep = function validateLoginsStep(test, expect) {\n    Meteor.call(\"testInvalidateLogins\", false, expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n    }));\n  };\n\n  testAsyncMulti(\"passwords - basic login with password\", [function (test, expect) {\n    // setup\n    this.username = Random.id();\n    this.email = Random.id() + '-intercept@example.com';\n    this.password = 'password';\n\n    Accounts.createUser({ username: this.username, email: this.email, password: this.password }, loggedInAs(this.username, test, expect));\n  }, function (test, expect) {\n    test.notEqual(Meteor.userId(), null);\n  }, logoutStep, function (test, expect) {\n    Meteor.loginWithPassword(this.username, this.password, loggedInAs(this.username, test, expect));\n  }, logoutStep,\n  // This next step tests reactive contexts which are reactive on\n  // Meteor.user().\n  function (test, expect) {\n    // Set up a reactive context that only refreshes when Meteor.user() is\n    // invalidated.\n    var loaded = false;\n    var handle = Tracker.autorun(function () {\n      if (Meteor.user() && Meteor.user().emails) loaded = true;\n    });\n    // At the beginning, we're not logged in.\n    test.isFalse(loaded);\n    Meteor.loginWithPassword(this.username, this.password, expect(function (error) {\n      test.equal(error, undefined);\n      test.notEqual(Meteor.userId(), null);\n      // By the time of the login callback, the user should be loaded.\n      test.isTrue(Meteor.user().emails);\n      // Flushing should get us the rerun as well.\n      Tracker.flush();\n      test.isTrue(loaded);\n      handle.stop();\n    }));\n  }, logoutStep, function (test, expect) {\n    Meteor.loginWithPassword({ username: this.username }, this.password, loggedInAs(this.username, test, expect));\n  }, logoutStep, function (test, expect) {\n    Meteor.loginWithPassword(this.email, this.password, loggedInAs(this.username, test, expect));\n  }, logoutStep, function (test, expect) {\n    Meteor.loginWithPassword({ email: this.email }, this.password, loggedInAs(this.username, test, expect));\n  }, logoutStep]);\n\n  testAsyncMulti(\"passwords - plain text passwords\", [function (test, expect) {\n    // setup\n    this.username = Random.id();\n    this.email = Random.id() + '-intercept@example.com';\n    this.password = 'password';\n\n    // create user with raw password (no API, need to invoke callLoginMethod\n    // directly)\n    Accounts.callLoginMethod({\n      methodName: 'createUser',\n      methodArguments: [{ username: this.username, password: this.password }],\n      userCallback: loggedInAs(this.username, test, expect)\n    });\n  }, logoutStep,\n  // check can login normally with this password.\n  function (test, expect) {\n    Meteor.loginWithPassword({ username: this.username }, this.password, loggedInAs(this.username, test, expect));\n  }, logoutStep,\n  // plain text password. no API for this, have to invoke callLoginMethod\n  // directly.\n  function (test, expect) {\n    Accounts.callLoginMethod({\n      // wrong password\n      methodArguments: [{ user: { username: this.username }, password: 'wrong' }],\n      userCallback: expect(function (error) {\n        test.isTrue(error);\n        test.isFalse(Meteor.user());\n      }) });\n  }, function (test, expect) {\n    Accounts.callLoginMethod({\n      // right password\n      methodArguments: [{ user: { username: this.username },\n        password: this.password }],\n      userCallback: loggedInAs(this.username, test, expect)\n    });\n  }, logoutStep]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username\", [createUserStep, logoutStep,\n  // We should be able to log in with the username in lower case\n  function (test, expect) {\n    Meteor.loginWithPassword({ username: \"adalovelace\" + this.randomSuffix }, this.password, loggedInAs(this.username, test, expect));\n  }]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username \" + \"with non-ASCII characters\", [function (test, expect) {\n    // Hack because Tinytest does not clean the database between tests/runs\n    this.randomSuffix = Random.id(10);\n    this.username = '√ÅdaL√òvelaüòàe' + this.randomSuffix;\n    this.password = 'password';\n    Accounts.createUser({ username: this.username, email: this.email, password: this.password }, loggedInAs(this.username, test, expect));\n  }, logoutStep,\n  // We should be able to log in with the username in lower case\n  function (test, expect) {\n    Meteor.loginWithPassword({ username: \"√°dal√∏velaüòàe\" + this.randomSuffix }, this.password, loggedInAs(this.username, test, expect));\n  }]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username \" + \"should escape regex special characters\", [createUserStep, logoutStep,\n  // We shouldn't be able to log in with a regex expression for the username\n  function (test, expect) {\n    Meteor.loginWithPassword({ username: \".+\" + this.randomSuffix }, this.password, expectUserNotFound(test, expect));\n  }]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username \" + \"should require a match of the full string\", [createUserStep, logoutStep,\n  // We shouldn't be able to log in with a partial match for the username\n  function (test, expect) {\n    Meteor.loginWithPassword({ username: \"lovelace\" + this.randomSuffix }, this.password, expectUserNotFound(test, expect));\n  }]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username when \" + \"there are multiple matches\", [createUserStep, logoutStep, function (test, expect) {\n    this.otherUsername = 'Adalovelace' + this.randomSuffix;\n    addSkipCaseInsensitiveChecksForTest(this.otherUsername, test, expect);\n  },\n  // Create another user with a username that only differs in case\n  function (test, expect) {\n    Accounts.createUser({ username: this.otherUsername, password: this.password }, loggedInAs(this.otherUsername, test, expect));\n  }, function (test, expect) {\n    removeSkipCaseInsensitiveChecksForTest(this.otherUsername, test, expect);\n  },\n  // We shouldn't be able to log in with the username in lower case\n  function (test, expect) {\n    Meteor.loginWithPassword({ username: \"adalovelace\" + this.randomSuffix }, this.password, expectUserNotFound(test, expect));\n  },\n  // We should still be able to log in with the username in original case\n  function (test, expect) {\n    Meteor.loginWithPassword({ username: this.username }, this.password, loggedInAs(this.username, test, expect));\n  }]);\n\n  testAsyncMulti(\"passwords - creating users with the same case insensitive \" + \"username\", [createUserStep, logoutStep,\n  // Attempting to create another user with a username that only differs in\n  // case should fail\n  function (test, expect) {\n    this.newUsername = 'adalovelace' + this.randomSuffix;\n    Accounts.createUser({ username: this.newUsername, password: this.password }, expectError(new Meteor.Error(403, \"Username already exists.\"), test, expect));\n  },\n  // Make sure the new user has not been inserted\n  function (test, expect) {\n    Meteor.call('countUsersOnServer', { username: this.newUsername }, expect(function (error, result) {\n      test.equal(result, 0);\n    }));\n  }]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive email\", [createUserStep, logoutStep,\n  // We should be able to log in with the email in lower case\n  function (test, expect) {\n    Meteor.loginWithPassword({ email: \"ada-intercept@lovelace.com\" + this.randomSuffix }, this.password, loggedInAs(this.username, test, expect));\n  }]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive email should \" + \"escape regex special characters\", [createUserStep, logoutStep,\n  // We shouldn't be able to log in with a regex expression for the email\n  function (test, expect) {\n    Meteor.loginWithPassword({ email: \".+\" + this.randomSuffix }, this.password, expectUserNotFound(test, expect));\n  }]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive email should \" + \"require a match of the full string\", [createUserStep, logoutStep,\n  // We shouldn't be able to log in with a partial match for the email\n  function (test, expect) {\n    Meteor.loginWithPassword({ email: \"com\" + this.randomSuffix }, this.password, expectUserNotFound(test, expect));\n  }]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive email when \" + \"there are multiple matches\", [createUserStep, logoutStep, function (test, expect) {\n    this.otherUsername = 'AdaLovelace' + Random.id(10);\n    this.otherEmail = \"ADA-intercept@lovelace.com\" + this.randomSuffix;\n    addSkipCaseInsensitiveChecksForTest(this.otherEmail, test, expect);\n  },\n  // Create another user with an email that only differs in case\n  function (test, expect) {\n    Accounts.createUser({ username: this.otherUsername,\n      email: this.otherEmail,\n      password: this.password }, loggedInAs(this.otherUsername, test, expect));\n  }, function (test, expect) {\n    removeSkipCaseInsensitiveChecksForTest(this.otherUsername, test, expect);\n  }, logoutStep,\n  // We shouldn't be able to log in with the email in lower case\n  function (test, expect) {\n    Meteor.loginWithPassword({ email: \"ada-intercept@lovelace.com\" + this.randomSuffix }, this.password, expectUserNotFound(test, expect));\n  },\n  // We should still be able to log in with the email in original case\n  function (test, expect) {\n    Meteor.loginWithPassword({ email: this.email }, this.password, loggedInAs(this.username, test, expect));\n  }]);\n\n  testAsyncMulti(\"passwords - creating users with the same case insensitive \" + \"email\", [createUserStep, logoutStep,\n  // Create user error without callback should throw error\n  function (test, expect) {\n    this.newUsername = 'adalovelace' + this.randomSuffix;\n    test.throws(function () {\n      Accounts.createUser({ username: this.newUsername, password: '' });\n    }, /Password may not be empty/);\n  },\n  // Attempting to create another user with an email that only differs in\n  // case should fail\n  function (test, expect) {\n    this.newEmail = \"ada-intercept@lovelace.com\" + this.randomSuffix;\n    Accounts.createUser({ email: this.newEmail, password: this.password }, expectError(new Meteor.Error(403, \"Email already exists.\"), test, expect));\n  },\n  // Make sure the new user has not been inserted\n  function (test, expect) {\n    Meteor.call('countUsersOnServer', { 'emails.address': this.newEmail }, expect(function (error, result) {\n      test.equal(result, 0);\n    }));\n  }]);\n\n  testAsyncMulti(\"passwords - changing passwords\", [function (test, expect) {\n    // setup\n    this.username = Random.id();\n    this.email = Random.id() + '-intercept@example.com';\n    this.password = 'password';\n    this.password2 = 'password2';\n\n    Accounts.createUser({ username: this.username, email: this.email, password: this.password }, loggedInAs(this.username, test, expect));\n  },\n  // Send a password reset email so that we can test that password\n  // reset tokens get deleted on password change.\n  function (test, expect) {\n    Meteor.call(\"forgotPassword\", { email: this.email }, expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, function (test, expect) {\n    var self = this;\n    Meteor.call(\"getResetToken\", expect(function (err, token) {\n      test.isFalse(err);\n      test.isTrue(token);\n      self.token = token;\n    }));\n  },\n  // change password with bad old password. we stay logged in.\n  function (test, expect) {\n    var self = this;\n    Accounts.changePassword('wrong', 'doesntmatter', expect(function (error) {\n      test.isTrue(error);\n      test.equal(Meteor.user().username, self.username);\n    }));\n  },\n  // change password with blank new password\n  function (test, expect) {\n    test.throws(function () {\n      Accounts.changePassword(this.password, '');\n    }, /Password may not be empty/);\n  },\n  // change password with good old password.\n  function (test, expect) {\n    Accounts.changePassword(this.password, this.password2, loggedInAs(this.username, test, expect));\n  }, function (test, expect) {\n    Meteor.call(\"getResetToken\", expect(function (err, token) {\n      test.isFalse(err);\n      test.isFalse(token);\n    }));\n  }, logoutStep,\n  // old password, failed login\n  function (test, expect) {\n    Meteor.loginWithPassword(this.email, this.password, expect(function (error) {\n      test.isTrue(error);\n      test.isFalse(Meteor.user());\n    }));\n  },\n  // new password, success\n  function (test, expect) {\n    Meteor.loginWithPassword(this.email, this.password2, loggedInAs(this.username, test, expect));\n  }, logoutStep]);\n\n  testAsyncMulti(\"passwords - changing password logs out other clients\", [function (test, expect) {\n    this.username = Random.id();\n    this.email = Random.id() + '-intercept@example.com';\n    this.password = 'password';\n    this.password2 = 'password2';\n    Accounts.createUser({ username: this.username, email: this.email, password: this.password }, loggedInAs(this.username, test, expect));\n  },\n  // Log in a second connection as this user.\n  function (test, expect) {\n    var self = this;\n\n    self.secondConn = DDP.connect(Meteor.absoluteUrl());\n    self.secondConn.call('login', { user: { username: self.username }, password: self.password }, expect(function (err, result) {\n      test.isFalse(err);\n      self.secondConn.setUserId(result.id);\n      test.isTrue(self.secondConn.userId());\n\n      self.secondConn.onReconnect = function () {\n        self.secondConn.apply('login', [{ resume: result.token }], { wait: true }, function (err, result) {\n          self.secondConn.setUserId(result && result.id || null);\n        });\n      };\n    }));\n  }, function (test, expect) {\n    var self = this;\n    Accounts.changePassword(self.password, self.password2, expect(function (err) {\n      test.isFalse(err);\n    }));\n  },\n  // Now that we've changed the password, wait until the second\n  // connection gets logged out.\n  function (test, expect) {\n    var self = this;\n    pollUntil(expect, function () {\n      return self.secondConn.userId() === null;\n    }, 10 * 1000, 100);\n  }]);\n\n  testAsyncMulti(\"passwords - forgotPassword client return error when empty email\", [function (test, expect) {\n    // setup\n    this.email = '';\n  },\n  // forgotPassword called on client with blank email\n  function (test, expect) {\n    Accounts.forgotPassword({ email: this.email }, expect(function (error) {\n      test.isTrue(error);\n    }));\n  },\n  // forgotPassword called on client with blank email and no callback.\n  function (test, expect) {\n    test.throws(function () {\n      Accounts.forgotPassword({ email: this.email });\n    }, /Must pass options\\.email/);\n  }]);\n\n  testAsyncMulti(\"passwords - verifyEmail client return error when empty token\", [function (test, expect) {\n    // setup\n    this.token = '';\n  },\n  // verifyEmail called on client with blank token\n  function (test, expect) {\n    Accounts.verifyEmail(this.token, expect(function (error) {\n      test.isTrue(error);\n    }));\n  },\n  // verifyEmail called on client with blank token and no callback.\n  function (test, expect) {\n    test.throws(function () {\n      Accounts.verifyEmail(this.token);\n    }, /Need to pass token/);\n  }]);\n\n  testAsyncMulti(\"passwords - resetPassword errors\", [function (test, expect) {\n    // setup\n    this.token = '';\n    this.newPassword = 'nonblankpassword';\n  },\n  // resetPassword called on client with blank token\n  function (test, expect) {\n    Accounts.resetPassword(this.token, this.newPassword, expect(function (error) {\n      test.isTrue(error);\n    }));\n  }, function (test, expect) {\n    // setup\n    this.token = 'nonblank-token';\n    this.newPassword = '';\n  },\n  // resetPassword called on client with blank password\n  function (test, expect) {\n    Accounts.resetPassword(this.token, this.newPassword, expect(function (error) {\n      test.isTrue(error);\n    }));\n  },\n  // resetPassword called on client with blank password and no callback.\n  function (test, expect) {\n    test.throws(function () {\n      Accounts.resetPassword(this.token, this.newPassword);\n    }, /Match error: Expected string, got undefined/);\n  }]);\n\n  testAsyncMulti(\"passwords - new user hooks\", [function (test, expect) {\n    // setup\n    this.username = Random.id();\n    this.email = Random.id() + '-intercept@example.com';\n    this.password = 'password';\n  },\n  // test Accounts.validateNewUser\n  function (test, expect) {\n    Accounts.createUser({ username: this.username, password: this.password,\n      // should fail the new user validators\n      profile: { invalid: true } }, expect(function (error) {\n      test.equal(error.error, 403);\n      test.equal(error.reason, \"User validation failed\");\n    }));\n  }, logoutStep, function (test, expect) {\n    Accounts.createUser({ username: this.username, password: this.password,\n      // should fail the new user validator with a special\n      // exception\n      profile: { invalidAndThrowException: true } }, expect(function (error) {\n      test.equal(error.reason, \"An exception thrown within Accounts.validateNewUser\");\n    }));\n  },\n  // test Accounts.onCreateUser\n  function (test, expect) {\n    Accounts.createUser({ username: this.username, password: this.password,\n      testOnCreateUserHook: true }, loggedInAs(this.username, test, expect));\n  }, function (test, expect) {\n    test.equal(Meteor.user().profile.touchedByOnCreateUser, true);\n  }, logoutStep]);\n\n  testAsyncMulti(\"passwords - Meteor.user()\", [function (test, expect) {\n    // setup\n    this.username = Random.id();\n    this.password = 'password';\n\n    Accounts.createUser({ username: this.username, password: this.password,\n      testOnCreateUserHook: true }, loggedInAs(this.username, test, expect));\n  },\n  // test Meteor.user(). This test properly belongs in\n  // accounts-base/accounts_tests.js, but this is where the tests that\n  // actually log in are.\n  function (test, expect) {\n    var self = this;\n    var clientUser = Meteor.user();\n    Accounts.connection.call('testMeteorUser', expect(function (err, result) {\n      test.equal(result._id, clientUser._id);\n      test.equal(result.username, clientUser.username);\n      test.equal(result.username, self.username);\n      test.equal(result.profile.touchedByOnCreateUser, true);\n      test.equal(err, undefined);\n    }));\n  }, function (test, expect) {\n    // Test that even with no published fields, we still have a document.\n    Accounts.connection.call('clearUsernameAndProfile', expect(function () {\n      test.isTrue(Meteor.userId());\n      var user = Meteor.user();\n      test.equal(user, { _id: Meteor.userId() });\n    }));\n  }, logoutStep, function (test, expect) {\n    var clientUser = Meteor.user();\n    test.equal(clientUser, null);\n    test.equal(Meteor.userId(), null);\n    Accounts.connection.call('testMeteorUser', expect(function (err, result) {\n      test.equal(err, undefined);\n      test.equal(result, null);\n    }));\n  }]);\n\n  testAsyncMulti(\"passwords - allow rules\", [\n  // create a second user to have an id for in a later test\n  function (test, expect) {\n    this.otherUsername = Random.id();\n    Accounts.createUser({ username: this.otherUsername, password: 'dontcare',\n      testOnCreateUserHook: true }, loggedInAs(this.otherUsername, test, expect));\n  }, function (test, expect) {\n    this.otherUserId = Meteor.userId();\n  }, function (test, expect) {\n    // real setup\n    this.username = Random.id();\n    this.password = 'password';\n\n    Accounts.createUser({ username: this.username, password: this.password,\n      testOnCreateUserHook: true }, loggedInAs(this.username, test, expect));\n  },\n  // test the default Meteor.users allow rule. This test properly belongs in\n  // accounts-base/accounts_tests.js, but this is where the tests that\n  // actually log in are.\n  function (test, expect) {\n    this.userId = Meteor.userId();\n    test.notEqual(this.userId, null);\n    test.notEqual(this.userId, this.otherUserId);\n    // Can't update fields other than profile.\n    Meteor.users.update(this.userId, { $set: { disallowed: true, 'profile.updated': 42 } }, expect(function (err) {\n      test.isTrue(err);\n      test.equal(err.error, 403);\n      test.isFalse(_.has(Meteor.user(), 'disallowed'));\n      test.isFalse(_.has(Meteor.user().profile, 'updated'));\n    }));\n  }, function (test, expect) {\n    // Can't update another user.\n    Meteor.users.update(this.otherUserId, { $set: { 'profile.updated': 42 } }, expect(function (err) {\n      test.isTrue(err);\n      test.equal(err.error, 403);\n    }));\n  }, function (test, expect) {\n    // Can't update using a non-ID selector. (This one is thrown client-side.)\n    test.throws(function () {\n      Meteor.users.update({ username: this.username }, { $set: { 'profile.updated': 42 } });\n    });\n    test.isFalse(_.has(Meteor.user().profile, 'updated'));\n  }, function (test, expect) {\n    // Can update own profile using ID.\n    Meteor.users.update(this.userId, { $set: { 'profile.updated': 42 } }, expect(function (err) {\n      test.isFalse(err);\n      test.equal(42, Meteor.user().profile.updated);\n    }));\n  }, logoutStep]);\n\n  testAsyncMulti(\"passwords - tokens\", [function (test, expect) {\n    // setup\n    this.username = Random.id();\n    this.password = 'password';\n\n    Accounts.createUser({ username: this.username, password: this.password }, loggedInAs(this.username, test, expect));\n  }, function (test, expect) {\n    // we can't login with an invalid token\n    var expectLoginError = expect(function (err) {\n      test.isTrue(err);\n    });\n    Meteor.loginWithToken('invalid', expectLoginError);\n  }, function (test, expect) {\n    // we can login with a valid token\n    var expectLoginOK = expect(function (err) {\n      test.isFalse(err);\n    });\n    Meteor.loginWithToken(Accounts._storedLoginToken(), expectLoginOK);\n  }, function (test, expect) {\n    // test logging out invalidates our token\n    var expectLoginError = expect(function (err) {\n      test.isTrue(err);\n    });\n    var token = Accounts._storedLoginToken();\n    test.isTrue(token);\n    Meteor.logout(function () {\n      Meteor.loginWithToken(token, expectLoginError);\n    });\n  }, function (test, expect) {\n    var self = this;\n    // Test that login tokens get expired. We should get logged out when a\n    // token expires, and not be able to log in again with the same token.\n    var expectNoError = expect(function (err) {\n      test.isFalse(err);\n    });\n\n    Meteor.loginWithPassword(this.username, this.password, function (error) {\n      self.token = Accounts._storedLoginToken();\n      test.isTrue(self.token);\n      expectNoError(error);\n      Accounts.connection.call(\"expireTokens\");\n    });\n  }, waitForLoggedOutStep, function (test, expect) {\n    var token = Accounts._storedLoginToken();\n    test.isFalse(token);\n  }, function (test, expect) {\n    // Test that once expireTokens is finished, we can't login again with our\n    // previous token.\n    Meteor.loginWithToken(this.token, expect(function (err, result) {\n      test.isTrue(err);\n      test.equal(Meteor.userId(), null);\n    }));\n  }, logoutStep, function (test, expect) {\n    var self = this;\n    // Test that Meteor.logoutOtherClients logs out a second\n    // authentcated connection while leaving Accounts.connection\n    // logged in.\n    var secondConn = DDP.connect(Meteor.absoluteUrl());\n    var token;\n\n    var expectSecondConnLoggedOut = expect(function (err, result) {\n      test.isTrue(err);\n    });\n\n    var expectAccountsConnLoggedIn = expect(function (err, result) {\n      test.isFalse(err);\n    });\n\n    var expectSecondConnLoggedIn = expect(function (err, result) {\n      test.equal(result.token, token);\n      test.isFalse(err);\n      Meteor.logoutOtherClients(function (err) {\n        test.isFalse(err);\n        secondConn.call('login', { resume: token }, expectSecondConnLoggedOut);\n        Accounts.connection.call('login', {\n          resume: Accounts._storedLoginToken()\n        }, expectAccountsConnLoggedIn);\n      });\n    });\n\n    Meteor.loginWithPassword(self.username, self.password, expect(function (err) {\n      test.isFalse(err);\n      token = Accounts._storedLoginToken();\n      test.isTrue(token);\n      secondConn.call('login', { resume: token }, expectSecondConnLoggedIn);\n    }));\n  }, logoutStep,\n\n  // The tests below this point are for the deprecated\n  // `logoutOtherClients` method.\n\n  function (test, expect) {\n    var self = this;\n\n    // Test that Meteor.logoutOtherClients logs out a second authenticated\n    // connection while leaving Accounts.connection logged in.\n    var token;\n    self.secondConn = DDP.connect(Meteor.absoluteUrl());\n\n    var expectLoginError = expect(function (err) {\n      test.isTrue(err);\n    });\n    var expectValidToken = expect(function (err, result) {\n      test.isFalse(err);\n      test.isTrue(result);\n      self.tokenFromLogoutOthers = result.token;\n    });\n    var expectSecondConnLoggedIn = expect(function (err, result) {\n      test.equal(result.token, token);\n      test.isFalse(err);\n      // This test will fail if an unrelated reconnect triggers before the\n      // connection is logged out. In general our tests aren't resilient to\n      // mid-test reconnects.\n      self.secondConn.onReconnect = function () {\n        self.secondConn.call(\"login\", { resume: token }, expectLoginError);\n      };\n      Accounts.connection.call(\"logoutOtherClients\", expectValidToken);\n    });\n\n    Meteor.loginWithPassword(this.username, this.password, expect(function (err) {\n      test.isFalse(err);\n      token = Accounts._storedLoginToken();\n      self.beforeLogoutOthersToken = token;\n      test.isTrue(token);\n      self.secondConn.call(\"login\", { resume: token }, expectSecondConnLoggedIn);\n    }));\n  },\n  // Test that logoutOtherClients logged out Accounts.connection and that the\n  // previous token is no longer valid.\n  waitForLoggedOutStep, function (test, expect) {\n    var self = this;\n    var token = Accounts._storedLoginToken();\n    test.isFalse(token);\n    this.secondConn.close();\n    Meteor.loginWithToken(self.beforeLogoutOthersToken, expect(function (err) {\n      test.isTrue(err);\n      test.isFalse(Meteor.userId());\n    }));\n  },\n  // Test that logoutOtherClients returned a new token that we can use to\n  // log in.\n  function (test, expect) {\n    var self = this;\n    Meteor.loginWithToken(self.tokenFromLogoutOthers, expect(function (err) {\n      test.isFalse(err);\n      test.isTrue(Meteor.userId());\n    }));\n  }, logoutStep, function (test, expect) {\n    var self = this;\n    // Test that deleting a user logs out that user's connections.\n    Meteor.loginWithPassword(this.username, this.password, expect(function (err) {\n      test.isFalse(err);\n      Accounts.connection.call(\"removeUser\", self.username);\n    }));\n  }, waitForLoggedOutStep]);\n\n  testAsyncMulti(\"passwords - validateLoginAttempt\", [function (test, expect) {\n    this.username = Random.id();\n    this.password = \"password\";\n\n    Accounts.createUser({ username: this.username, password: this.password }, loggedInAs(this.username, test, expect));\n  }, logoutStep, invalidateLoginsStep, function (test, expect) {\n    Meteor.loginWithPassword(this.username, this.password, expect(function (error) {\n      test.isTrue(error);\n      test.equal(error.reason, \"Login forbidden\");\n    }));\n  }, validateLoginsStep, function (test, expect) {\n    Meteor.loginWithPassword(\"no such user\", \"some password\", expect(function (error) {\n      test.isTrue(error);\n      test.equal(error.reason, 'User not found');\n    }));\n  }, hideActualLoginErrorStep, function (test, expect) {\n    Meteor.loginWithPassword(\"no such user\", \"some password\", expect(function (error) {\n      test.isTrue(error);\n      test.equal(error.reason, 'hide actual error');\n    }));\n  }, validateLoginsStep]);\n\n  testAsyncMulti(\"passwords - server onLogin hook\", [function (test, expect) {\n    Meteor.call(\"testCaptureLogins\", expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, function (test, expect) {\n    this.username = Random.id();\n    this.password = \"password\";\n\n    Accounts.createUser({ username: this.username, password: this.password }, loggedInAs(this.username, test, expect));\n  }, function (test, expect) {\n    var self = this;\n    Meteor.call(\"testFetchCapturedLogins\", expect(function (error, logins) {\n      test.isFalse(error);\n      test.equal(logins.length, 1);\n      var login = logins[0];\n      test.isTrue(login.successful);\n      var attempt = login.attempt;\n      test.equal(attempt.type, \"password\");\n      test.isTrue(attempt.allowed);\n      test.equal(attempt.methodArguments[0].username, self.username);\n    }));\n  }]);\n\n  testAsyncMulti(\"passwords - client onLogin hook\", [function (test, expect) {\n    var self = this;\n    this.username = Random.id();\n    this.password = \"password\";\n    this.attempt = false;\n\n    this.onLogin = Accounts.onLogin(function (attempt) {\n      self.attempt = true;\n    });\n\n    Accounts.createUser({ username: this.username, password: this.password }, loggedInAs(this.username, test, expect));\n  }, function (test, expect) {\n    this.onLogin.stop();\n    test.isTrue(this.attempt);\n    expect(function () {})();\n  }]);\n\n  testAsyncMulti(\"passwords - server onLogout hook\", [function (test, expect) {\n    Meteor.call(\"testCaptureLogouts\", expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, function (test, expect) {\n    this.username = Random.id();\n    this.password = \"password\";\n\n    Accounts.createUser({ username: this.username, password: this.password }, loggedInAs(this.username, test, expect));\n  }, logoutStep, function (test, expect) {\n    var self = this;\n    Meteor.call(\"testFetchCapturedLogouts\", expect(function (error, logouts) {\n      test.isFalse(error);\n      test.equal(logouts.length, 1);\n      var logout = logouts[0];\n      test.isTrue(logout.successful);\n    }));\n  }]);\n\n  testAsyncMulti(\"passwords - client onLogout hook\", [function (test, expect) {\n    var self = this;\n    this.username = Random.id();\n    this.password = \"password\";\n    this.attempt = false;\n\n    this.onLogout = Accounts.onLogout(function () {\n      self.logoutSuccess = true;\n    });\n\n    Accounts.createUser({ username: this.username, password: this.password }, loggedInAs(this.username, test, expect));\n  }, logoutStep, function (test, expect) {\n    test.isTrue(this.logoutSuccess);\n    expect(function () {})();\n  }]);\n\n  testAsyncMulti(\"passwords - server onLoginFailure hook\", [function (test, expect) {\n    this.username = Random.id();\n    this.password = \"password\";\n\n    Accounts.createUser({ username: this.username, password: this.password }, loggedInAs(this.username, test, expect));\n  }, logoutStep, function (test, expect) {\n    Meteor.call(\"testCaptureLogins\", expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, function (test, expect) {\n    Meteor.loginWithPassword(this.username, \"incorrect\", expect(function (error) {\n      test.isTrue(error);\n    }));\n  }, function (test, expect) {\n    Meteor.call(\"testFetchCapturedLogins\", expect(function (error, logins) {\n      test.isFalse(error);\n      test.equal(logins.length, 1);\n      var login = logins[0];\n      test.isFalse(login.successful);\n      var attempt = login.attempt;\n      test.equal(attempt.type, \"password\");\n      test.isFalse(attempt.allowed);\n      test.equal(attempt.error.reason, \"Incorrect password\");\n    }));\n  }, function (test, expect) {\n    Meteor.call(\"testCaptureLogins\", expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, function (test, expect) {\n    Meteor.loginWithPassword(\"no such user\", \"incorrect\", expect(function (error) {\n      test.isTrue(error);\n    }));\n  }, function (test, expect) {\n    Meteor.call(\"testFetchCapturedLogins\", expect(function (error, logins) {\n      test.isFalse(error);\n      test.equal(logins.length, 1);\n      var login = logins[0];\n      test.isFalse(login.successful);\n      var attempt = login.attempt;\n      test.equal(attempt.type, \"password\");\n      test.isFalse(attempt.allowed);\n      test.equal(attempt.error.reason, \"User not found\");\n    }));\n  }]);\n\n  testAsyncMulti(\"passwords - client onLoginFailure hook\", [function (test, expect) {\n    var self = this;\n    this.username = Random.id();\n    this.password = \"password\";\n    this.attempt = false;\n\n    this.onLoginFailure = Accounts.onLoginFailure(function () {\n      self.attempt = true;\n    });\n\n    Accounts.createUser({ username: this.username, password: this.password }, loggedInAs(this.username, test, expect));\n  }, logoutStep, function (test, expect) {\n    Meteor.call(\"testCaptureLogins\", expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, function (test, expect) {\n    Meteor.loginWithPassword(this.username, \"incorrect\", expect(function (error) {\n      test.isTrue(error);\n    }));\n  }, function (test, expect) {\n    this.onLoginFailure.stop();\n    test.isTrue(this.attempt);\n    expect(function () {})();\n  }]);\n\n  testAsyncMulti(\"passwords - srp to bcrypt upgrade\", [logoutStep,\n  // Create user with old SRP credentials in the database.\n  function (test, expect) {\n    var self = this;\n    Meteor.call(\"testCreateSRPUser\", expect(function (error, result) {\n      test.isFalse(error);\n      self.username = result;\n    }));\n  },\n  // We are able to login with the old style credentials in the database.\n  function (test, expect) {\n    Meteor.loginWithPassword(this.username, 'abcdef', expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, function (test, expect) {\n    Meteor.call(\"testSRPUpgrade\", this.username, expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, logoutStep,\n  // After the upgrade to bcrypt we're still able to login.\n  function (test, expect) {\n    Meteor.loginWithPassword(this.username, 'abcdef', expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, logoutStep, function (test, expect) {\n    Meteor.call(\"removeUser\", this.username, expect(function (error) {\n      test.isFalse(error);\n    }));\n  }]);\n\n  testAsyncMulti(\"passwords - srp to bcrypt upgrade via password change\", [logoutStep,\n  // Create user with old SRP credentials in the database.\n  function (test, expect) {\n    var self = this;\n    Meteor.call(\"testCreateSRPUser\", expect(function (error, result) {\n      test.isFalse(error);\n      self.username = result;\n    }));\n  },\n  // Log in with the plaintext password handler, which should NOT upgrade us to bcrypt.\n  function (test, expect) {\n    Accounts.callLoginMethod({\n      methodName: \"login\",\n      methodArguments: [{ user: { username: this.username }, password: \"abcdef\" }],\n      userCallback: expect(function (err) {\n        test.isFalse(err);\n      })\n    });\n  }, function (test, expect) {\n    Meteor.call(\"testNoSRPUpgrade\", this.username, expect(function (error) {\n      test.isFalse(error);\n    }));\n  },\n  // Changing our password should upgrade us to bcrypt.\n  function (test, expect) {\n    Accounts.changePassword(\"abcdef\", \"abcdefg\", expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, function (test, expect) {\n    Meteor.call(\"testSRPUpgrade\", this.username, expect(function (error) {\n      test.isFalse(error);\n    }));\n  },\n  // And after the upgrade we should be able to change our password again.\n  function (test, expect) {\n    Accounts.changePassword(\"abcdefg\", \"abcdef\", expect(function (error) {\n      test.isFalse(error);\n    }));\n  }, logoutStep]);\n})();\n\nif (Meteor.isServer) (function () {\n\n  Tinytest.add('passwords - setup more than one onCreateUserHook', function (test) {\n    test.throws(function () {\n      Accounts.onCreateUser(function () {});\n    });\n  });\n\n  Tinytest.add('passwords - createUser hooks', function (test) {\n    var username = Random.id();\n    test.throws(function () {\n      // should fail the new user validators\n      Accounts.createUser({ username: username, profile: { invalid: true } });\n    });\n\n    var userId = Accounts.createUser({ username: username,\n      testOnCreateUserHook: true });\n\n    test.isTrue(userId);\n    var user = Meteor.users.findOne(userId);\n    test.equal(user.profile.touchedByOnCreateUser, true);\n  });\n\n  Tinytest.add('passwords - setPassword', function (test) {\n    var username = Random.id();\n    var email = username + '-intercept@example.com';\n\n    var userId = Accounts.createUser({ username: username, email: email });\n\n    var user = Meteor.users.findOne(userId);\n    // no services yet.\n    test.equal(user.services.password, undefined);\n\n    // set a new password.\n    Accounts.setPassword(userId, 'new password');\n    user = Meteor.users.findOne(userId);\n    var oldSaltedHash = user.services.password.bcrypt;\n    test.isTrue(oldSaltedHash);\n\n    // Send a reset password email (setting a reset token) and insert a login\n    // token.\n    Accounts.sendResetPasswordEmail(userId, email);\n    Accounts._insertLoginToken(userId, Accounts._generateStampedLoginToken());\n    test.isTrue(Meteor.users.findOne(userId).services.password.reset);\n    test.isTrue(Meteor.users.findOne(userId).services.resume.loginTokens);\n\n    // reset with the same password, see we get a different salted hash\n    Accounts.setPassword(userId, 'new password', { logout: false });\n    user = Meteor.users.findOne(userId);\n    var newSaltedHash = user.services.password.bcrypt;\n    test.isTrue(newSaltedHash);\n    test.notEqual(oldSaltedHash, newSaltedHash);\n    // No more reset token.\n    test.isFalse(Meteor.users.findOne(userId).services.password.reset);\n    // But loginTokens are still here since we did logout: false.\n    test.isTrue(Meteor.users.findOne(userId).services.resume.loginTokens);\n\n    // reset again, see that the login tokens are gone.\n    Accounts.setPassword(userId, 'new password');\n    user = Meteor.users.findOne(userId);\n    var newerSaltedHash = user.services.password.bcrypt;\n    test.isTrue(newerSaltedHash);\n    test.notEqual(oldSaltedHash, newerSaltedHash);\n    test.notEqual(newSaltedHash, newerSaltedHash);\n    // No more tokens.\n    test.isFalse(Meteor.users.findOne(userId).services.password.reset);\n    test.isFalse(Meteor.users.findOne(userId).services.resume.loginTokens);\n\n    // cleanup\n    Meteor.users.remove(userId);\n  });\n\n  // This test properly belongs in accounts-base/accounts_tests.js, but\n  // this is where the tests that actually log in are.\n  Tinytest.add('accounts - user() out of context', function (test) {\n    // basic server context, no method.\n    test.throws(function () {\n      Meteor.user();\n    });\n  });\n\n  // XXX would be nice to test\n  // Accounts.config({forbidClientAccountCreation: true})\n\n  Tinytest.addAsync('passwords - login token observes get cleaned up', function (test, onComplete) {\n    var username = Random.id();\n    Accounts.createUser({\n      username: username,\n      password: 'password'\n    });\n\n    makeTestConnection(test, function (clientConn, serverConn) {\n      serverConn.onClose(function () {\n        test.isFalse(Accounts._getUserObserve(serverConn.id));\n        onComplete();\n      });\n      var result = clientConn.call('login', {\n        user: { username: username },\n        password: 'password'\n      });\n      test.isTrue(result);\n      var token = Accounts._getAccountData(serverConn.id, 'loginToken');\n      test.isTrue(token);\n\n      // We poll here, instead of just checking `_getUserObserve`\n      // once, because the login method defers the creation of the\n      // observe, and setting up the observe yields, so we could end\n      // up here before the observe has been set up.\n      simplePoll(function () {\n        return !!Accounts._getUserObserve(serverConn.id);\n      }, function () {\n        test.isTrue(Accounts._getUserObserve(serverConn.id));\n        clientConn.disconnect();\n      }, function () {\n        test.fail(\"timed out waiting for user observe for connection \" + serverConn.id);\n        onComplete();\n      });\n    }, onComplete);\n  });\n\n  Tinytest.add('passwords - reset password doesn\\t work if email changed after email sent', function (test) {\n    var username = Random.id();\n    var email = username + '-intercept@example.com';\n\n    var userId = Accounts.createUser({\n      username: username,\n      email: email,\n      password: \"old-password\"\n    });\n\n    var user = Meteor.users.findOne(userId);\n\n    Accounts.sendResetPasswordEmail(userId, email);\n\n    var resetPasswordEmailOptions = Meteor.call(\"getInterceptedEmails\", email)[0];\n\n    var re = new RegExp(Meteor.absoluteUrl() + \"#/reset-password/(\\\\S*)\");\n    var match = resetPasswordEmailOptions.text.match(re);\n    test.isTrue(match);\n    var resetPasswordToken = match[1];\n\n    var newEmail = Random.id() + '-new@example.com';\n    Meteor.users.update(userId, { $set: { \"emails.0.address\": newEmail } });\n\n    test.throws(function () {\n      Meteor.call(\"resetPassword\", resetPasswordToken, \"new-password\");\n    }, /Token has invalid email address/);\n    test.throws(function () {\n      Meteor.call(\"login\", { user: { username: username }, password: \"new-password\" });\n    }, /Incorrect password/);\n  });\n\n  Tinytest.addAsync('passwords - reset password should work when token is not expired', function (test, onComplete) {\n    var username = Random.id();\n    var email = username + '-intercept@example.com';\n\n    var userId = Accounts.createUser({\n      username: username,\n      email: email,\n      password: \"old-password\"\n    });\n\n    var user = Meteor.users.findOne(userId);\n\n    Accounts.sendResetPasswordEmail(userId, email);\n\n    var resetPasswordEmailOptions = Meteor.call(\"getInterceptedEmails\", email)[0];\n\n    var re = new RegExp(Meteor.absoluteUrl() + \"#/reset-password/(\\\\S*)\");\n    var match = resetPasswordEmailOptions.text.match(re);\n    test.isTrue(match);\n    var resetPasswordToken = match[1];\n\n    makeTestConnection(test, function (clientConn) {\n      test.isTrue(clientConn.call(\"resetPassword\", resetPasswordToken, \"new-password\"));\n\n      test.isTrue(clientConn.call(\"login\", {\n        user: { username: username },\n        password: \"new-password\"\n      }));\n\n      onComplete();\n    });\n  });\n\n  Tinytest.add('passwords - reset password should not work when token is expired', function (test) {\n    var username = Random.id();\n    var email = username + '-intercept@example.com';\n\n    var userId = Accounts.createUser({\n      username: username,\n      email: email,\n      password: \"old-password\"\n    });\n\n    var user = Meteor.users.findOne(userId);\n\n    Accounts.sendResetPasswordEmail(userId, email);\n\n    var resetPasswordEmailOptions = Meteor.call(\"getInterceptedEmails\", email)[0];\n\n    var re = new RegExp(Meteor.absoluteUrl() + \"#/reset-password/(\\\\S*)\");\n    var match = resetPasswordEmailOptions.text.match(re);\n    test.isTrue(match);\n    var resetPasswordToken = match[1];\n\n    Meteor.users.update(userId, { $set: { \"services.password.reset.when\": new Date(Date.now() + -5 * 24 * 3600 * 1000) } });\n\n    test.throws(function () {\n      Meteor.call(\"resetPassword\", resetPasswordToken, \"new-password\");\n    }, /Token expired/);\n    test.throws(function () {\n      Meteor.call(\"login\", { user: { username: username }, password: \"new-password\" });\n    }, /Incorrect password/);\n  });\n\n  Tinytest.add('passwords - reset tokens with reasons get cleaned up', function (test) {\n    var email = test.id + '-intercept@example.com';\n    var userId = Accounts.createUser({ email: email, password: 'password' });\n    Accounts.sendResetPasswordEmail(userId, email);\n    test.isTrue(!!Meteor.users.findOne(userId).services.password.reset);\n\n    Accounts._expirePasswordResetTokens(new Date(), userId);\n\n    test.isUndefined(Meteor.users.findOne(userId).services.password.reset);\n  });\n\n  Tinytest.add('passwords - reset tokens without reasons get cleaned up', function (test) {\n    var email = test.id + '-intercept@example.com';\n    var userId = Accounts.createUser({ email: email, password: 'password' });\n    Accounts.sendResetPasswordEmail(userId, email);\n    Meteor.users.update({ _id: userId }, { $unset: { \"services.password.reset.reason\": 1 } });\n    test.isTrue(!!Meteor.users.findOne(userId).services.password.reset);\n    test.isUndefined(Meteor.users.findOne(userId).services.password.reset.reason);\n\n    Accounts._expirePasswordResetTokens(new Date(), userId);\n\n    test.isUndefined(Meteor.users.findOne(userId).services.password.reset);\n  });\n\n  Tinytest.addAsync('passwords - enroll password should work when token is not expired', function (test, onComplete) {\n    var username = Random.id();\n    var email = username + '-intercept@example.com';\n\n    var userId = Accounts.createUser({\n      username: username,\n      email: email\n    });\n\n    var user = Meteor.users.findOne(userId);\n\n    Accounts.sendEnrollmentEmail(userId, email);\n\n    var enrollPasswordEmailOptions = Meteor.call(\"getInterceptedEmails\", email)[0];\n\n    var re = new RegExp(Meteor.absoluteUrl() + \"#/enroll-account/(\\\\S*)\");\n    var match = enrollPasswordEmailOptions.text.match(re);\n    test.isTrue(match);\n    var enrollPasswordToken = match[1];\n\n    makeTestConnection(test, function (clientConn) {\n      test.isTrue(clientConn.call(\"resetPassword\", enrollPasswordToken, \"new-password\"));\n\n      test.isTrue(clientConn.call(\"login\", {\n        user: { username: username },\n        password: \"new-password\"\n      }));\n\n      onComplete();\n    });\n  });\n\n  Tinytest.add('passwords - enroll password should not work when token is expired', function (test) {\n    var username = Random.id();\n    var email = username + '-intercept@example.com';\n\n    var userId = Accounts.createUser({\n      username: username,\n      email: email\n    });\n\n    var user = Meteor.users.findOne(userId);\n\n    Accounts.sendEnrollmentEmail(userId, email);\n\n    var enrollPasswordEmailOptions = Meteor.call(\"getInterceptedEmails\", email)[0];\n\n    var re = new RegExp(Meteor.absoluteUrl() + \"#/enroll-account/(\\\\S*)\");\n    var match = enrollPasswordEmailOptions.text.match(re);\n    test.isTrue(match);\n    var enrollPasswordToken = match[1];\n\n    Meteor.users.update(userId, { $set: { \"services.password.reset.when\": new Date(Date.now() + -35 * 24 * 3600 * 1000) } });\n\n    test.throws(function () {\n      Meteor.call(\"resetPassword\", enrollPasswordToken, \"new-password\");\n    }, /Token expired/);\n  });\n\n  Tinytest.add('passwords - enroll tokens get cleaned up', function (test) {\n    var email = test.id + '-intercept@example.com';\n    var userId = Accounts.createUser({ email: email, password: 'password' });\n    Accounts.sendEnrollmentEmail(userId, email);\n    test.isTrue(!!Meteor.users.findOne(userId).services.password.reset);\n\n    Accounts._expirePasswordEnrollTokens(new Date(), userId);\n\n    test.isUndefined(Meteor.users.findOne(userId).services.password.reset);\n  });\n\n  // We should be able to change the username\n  Tinytest.add(\"passwords - change username\", function (test) {\n    var username = Random.id();\n    var userId = Accounts.createUser({\n      username: username\n    });\n\n    test.isTrue(userId);\n\n    var newUsername = Random.id();\n    Accounts.setUsername(userId, newUsername);\n\n    test.equal(Accounts._findUserByQuery({ id: userId }).username, newUsername);\n\n    // Test findUserByUsername as well while we're here\n    test.equal(Accounts.findUserByUsername(newUsername)._id, userId);\n  });\n\n  Tinytest.add(\"passwords - change username to a new one only differing \" + \"in case\", function (test) {\n    var username = Random.id() + \"user\";\n    var userId = Accounts.createUser({\n      username: username.toUpperCase()\n    });\n\n    test.isTrue(userId);\n\n    var newUsername = username.toLowerCase();\n    Accounts.setUsername(userId, newUsername);\n\n    test.equal(Accounts._findUserByQuery({ id: userId }).username, newUsername);\n  });\n\n  // We should not be able to change the username to one that only\n  // differs in case from an existing one\n  Tinytest.add(\"passwords - change username should fail when there are \" + \"existing users with a username only differing in case\", function (test) {\n    var username = Random.id() + \"user\";\n    var usernameUpper = username.toUpperCase();\n\n    var userId1 = Accounts.createUser({\n      username: username\n    });\n\n    var user2OriginalUsername = Random.id();\n    var userId2 = Accounts.createUser({\n      username: user2OriginalUsername\n    });\n\n    test.isTrue(userId1);\n    test.isTrue(userId2);\n\n    test.throws(function () {\n      Accounts.setUsername(userId2, usernameUpper);\n    }, /Username already exists/);\n\n    test.equal(Accounts._findUserByQuery({ id: userId2 }).username, user2OriginalUsername);\n  });\n\n  Tinytest.add(\"passwords - add email\", function (test) {\n    var origEmail = Random.id() + \"@turing.com\";\n    var userId = Accounts.createUser({\n      email: origEmail\n    });\n\n    var newEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, newEmail);\n\n    var thirdEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, thirdEmail, true);\n\n    test.equal(Accounts._findUserByQuery({ id: userId }).emails, [{ address: origEmail, verified: false }, { address: newEmail, verified: false }, { address: thirdEmail, verified: true }]);\n\n    // Test findUserByEmail as well while we're here\n    test.equal(Accounts.findUserByEmail(origEmail)._id, userId);\n  });\n\n  Tinytest.add(\"passwords - add email when the user has an existing email \" + \"only differing in case\", function (test) {\n    var origEmail = Random.id() + \"@turing.com\";\n    var userId = Accounts.createUser({\n      email: origEmail\n    });\n\n    var newEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, newEmail);\n\n    var thirdEmail = origEmail.toUpperCase();\n    Accounts.addEmail(userId, thirdEmail, true);\n\n    test.equal(Accounts._findUserByQuery({ id: userId }).emails, [{ address: thirdEmail, verified: true }, { address: newEmail, verified: false }]);\n  });\n\n  Tinytest.add(\"passwords - add email should fail when there is an existing \" + \"user with an email only differing in case\", function (test) {\n    var user1Email = Random.id() + \"@turing.com\";\n    var userId1 = Accounts.createUser({\n      email: user1Email\n    });\n\n    var user2Email = Random.id() + \"@turing.com\";\n    var userId2 = Accounts.createUser({\n      email: user2Email\n    });\n\n    var dupEmail = user1Email.toUpperCase();\n    test.throws(function () {\n      Accounts.addEmail(userId2, dupEmail);\n    }, /Email already exists/);\n\n    test.equal(Accounts._findUserByQuery({ id: userId1 }).emails, [{ address: user1Email, verified: false }]);\n\n    test.equal(Accounts._findUserByQuery({ id: userId2 }).emails, [{ address: user2Email, verified: false }]);\n  });\n\n  Tinytest.add(\"passwords - remove email\", function (test) {\n    var origEmail = Random.id() + \"@turing.com\";\n    var userId = Accounts.createUser({\n      email: origEmail\n    });\n\n    var newEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, newEmail);\n\n    var thirdEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, thirdEmail, true);\n\n    test.equal(Accounts._findUserByQuery({ id: userId }).emails, [{ address: origEmail, verified: false }, { address: newEmail, verified: false }, { address: thirdEmail, verified: true }]);\n\n    Accounts.removeEmail(userId, newEmail);\n\n    test.equal(Accounts._findUserByQuery({ id: userId }).emails, [{ address: origEmail, verified: false }, { address: thirdEmail, verified: true }]);\n\n    Accounts.removeEmail(userId, origEmail);\n\n    test.equal(Accounts._findUserByQuery({ id: userId }).emails, [{ address: thirdEmail, verified: true }]);\n  });\n})();","ast":null,"map":{"version":3,"sources":["/packages/accounts-password/password_tests.js"],"names":["Accounts","_noConnectionCloseDelayForTest","Meteor","isServer","removeDefaultRateLimit","methods","getResetToken","token","users","findOne","userId","services","password","reset","addSkipCaseInsensitiveChecksForTest","value","_skipCaseInsensitiveChecksForTest","removeSkipCaseInsensitiveChecksForTest","countUsersOnServer","query","find","count","isClient","_isolateLoginTokenForTest","test","expect","call","createUserStep","randomSuffix","Random","id","username","email","createUser","loggedInAs","logoutStep","logout","error","fail","message","equal","user","someUsername","loggedInUserHasEmail","someEmail","isTrue","_","some","emails","address","expectError","expectedError","actualError","reason","expectUserNotFound","Error","waitForLoggedOutStep","pollUntil","invalidateLoginsStep","hideActualLoginErrorStep","validateLoginsStep","testAsyncMulti","notEqual","loginWithPassword","loaded","handle","Tracker","autorun","isFalse","undefined","flush","stop","callLoginMethod","methodName","methodArguments","userCallback","otherUsername","newUsername","result","otherEmail","throws","newEmail","password2","self","err","changePassword","secondConn","DDP","connect","absoluteUrl","setUserId","onReconnect","apply","resume","wait","forgotPassword","verifyEmail","newPassword","resetPassword","profile","invalid","invalidAndThrowException","testOnCreateUserHook","touchedByOnCreateUser","clientUser","connection","_id","otherUserId","update","$set","disallowed","has","updated","expectLoginError","loginWithToken","expectLoginOK","_storedLoginToken","expectNoError","expectSecondConnLoggedOut","expectAccountsConnLoggedIn","expectSecondConnLoggedIn","logoutOtherClients","expectValidToken","tokenFromLogoutOthers","beforeLogoutOthersToken","close","logins","length","login","successful","attempt","type","allowed","onLogin","logouts","onLogout","logoutSuccess","onLoginFailure","Tinytest","add","onCreateUser","setPassword","oldSaltedHash","bcrypt","sendResetPasswordEmail","_insertLoginToken","_generateStampedLoginToken","loginTokens","newSaltedHash","newerSaltedHash","remove","addAsync","onComplete","makeTestConnection","clientConn","serverConn","onClose","_getUserObserve","_getAccountData","simplePoll","disconnect","resetPasswordEmailOptions","re","RegExp","match","text","resetPasswordToken","Date","now","_expirePasswordResetTokens","isUndefined","$unset","sendEnrollmentEmail","enrollPasswordEmailOptions","enrollPasswordToken","_expirePasswordEnrollTokens","setUsername","_findUserByQuery","findUserByUsername","toUpperCase","toLowerCase","usernameUpper","userId1","user2OriginalUsername","userId2","origEmail","addEmail","thirdEmail","verified","findUserByEmail","user1Email","user2Email","dupEmail","removeEmail"],"mappings":"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","file":"/packages/accounts-password/password_tests.js.map","sourcesContent":["Accounts._noConnectionCloseDelayForTest = true;\n\nif (Meteor.isServer) {\n  Accounts.removeDefaultRateLimit();\n  \n  Meteor.methods({\n    getResetToken: function () {\n      var token = Meteor.users.findOne(this.userId).services.password.reset;\n      return token;\n    },\n    addSkipCaseInsensitiveChecksForTest: function (value) {\n      Accounts._skipCaseInsensitiveChecksForTest[value] = true;\n    },\n    removeSkipCaseInsensitiveChecksForTest: function (value) {\n      delete Accounts._skipCaseInsensitiveChecksForTest[value];\n    },\n    countUsersOnServer: function (query) {\n      return Meteor.users.find(query).count();\n    }\n  });\n}\n\nif (Meteor.isClient) (function () {\n\n  // XXX note, only one test can do login/logout things at once! for\n  // now, that is this test.\n\n  Accounts._isolateLoginTokenForTest();\n\n  var addSkipCaseInsensitiveChecksForTest = function (value, test, expect) {\n    Meteor.call('addSkipCaseInsensitiveChecksForTest', value);\n  };\n\n  var removeSkipCaseInsensitiveChecksForTest = function (value, test, expect) {\n    Meteor.call('removeSkipCaseInsensitiveChecksForTest', value);\n  };\n\n  var createUserStep = function (test, expect) {\n    // Hack because Tinytest does not clean the database between tests/runs\n    this.randomSuffix = Random.id(10);\n    this.username = 'AdaLovelace' + this.randomSuffix;\n    this.email =  \"Ada-intercept@lovelace.com\" + this.randomSuffix;\n    this.password = 'password';\n    Accounts.createUser(\n      {username: this.username, email: this.email, password: this.password},\n      loggedInAs(this.username, test, expect));\n  };\n  var logoutStep = function (test, expect) {\n    Meteor.logout(expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n      test.equal(Meteor.user(), null);\n    }));\n  };\n  var loggedInAs = function (someUsername, test, expect) {\n    return expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n      test.equal(Meteor.userId() && Meteor.user().username, someUsername);\n    });\n  };\n  var loggedInUserHasEmail = function (someEmail, test, expect) {\n    return expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n      var user = Meteor.user();\n      test.isTrue(user && _.some(user.emails, function(email) {\n        return email.address === someEmail;\n      }));\n    });\n  };\n  var expectError = function (expectedError, test, expect) {\n    return expect(function (actualError) {\n      test.equal(actualError && actualError.error, expectedError.error);\n      test.equal(actualError && actualError.reason, expectedError.reason);\n    });\n  };\n  var expectUserNotFound = function (test, expect) {\n    return expectError(new Meteor.Error(403, \"User not found\"), test, expect);\n  };\n  var waitForLoggedOutStep = function (test, expect) {\n    pollUntil(expect, function () {\n      return Meteor.userId() === null;\n    }, 10 * 1000, 100);\n  };\n  var invalidateLoginsStep = function (test, expect) {\n    Meteor.call(\"testInvalidateLogins\", 'fail', expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n    }));\n  };\n  var hideActualLoginErrorStep = function (test, expect) {\n    Meteor.call(\"testInvalidateLogins\", 'hide', expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n    }));\n  };\n  var validateLoginsStep = function (test, expect) {\n    Meteor.call(\"testInvalidateLogins\", false, expect(function (error) {\n      if (error) {\n        test.fail(error.message);\n      }\n    }));\n  };\n\n  testAsyncMulti(\"passwords - basic login with password\", [\n    function (test, expect) {\n      // setup\n      this.username = Random.id();\n      this.email = Random.id() + '-intercept@example.com';\n      this.password = 'password';\n\n      Accounts.createUser(\n        {username: this.username, email: this.email, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n    function (test, expect) {\n      test.notEqual(Meteor.userId(), null);\n    },\n    logoutStep,\n    function (test, expect) {\n      Meteor.loginWithPassword(this.username, this.password,\n                               loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    // This next step tests reactive contexts which are reactive on\n    // Meteor.user().\n    function (test, expect) {\n      // Set up a reactive context that only refreshes when Meteor.user() is\n      // invalidated.\n      var loaded = false;\n      var handle = Tracker.autorun(function () {\n        if (Meteor.user() && Meteor.user().emails)\n          loaded = true;\n      });\n      // At the beginning, we're not logged in.\n      test.isFalse(loaded);\n      Meteor.loginWithPassword(this.username, this.password, expect(function (error) {\n        test.equal(error, undefined);\n        test.notEqual(Meteor.userId(), null);\n        // By the time of the login callback, the user should be loaded.\n        test.isTrue(Meteor.user().emails);\n        // Flushing should get us the rerun as well.\n        Tracker.flush();\n        test.isTrue(loaded);\n        handle.stop();\n      }));\n    },\n    logoutStep,\n    function (test, expect) {\n      Meteor.loginWithPassword({username: this.username}, this.password,\n                               loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    function (test, expect) {\n      Meteor.loginWithPassword(this.email, this.password,\n                               loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    function (test, expect) {\n      Meteor.loginWithPassword({email: this.email}, this.password,\n                               loggedInAs(this.username, test, expect));\n    },\n    logoutStep\n  ]);\n\n\n  testAsyncMulti(\"passwords - plain text passwords\", [\n    function (test, expect) {\n      // setup\n      this.username = Random.id();\n      this.email = Random.id() + '-intercept@example.com';\n      this.password = 'password';\n\n      // create user with raw password (no API, need to invoke callLoginMethod\n      // directly)\n      Accounts.callLoginMethod({\n        methodName: 'createUser',\n        methodArguments: [{username: this.username, password: this.password}],\n        userCallback: loggedInAs(this.username, test, expect)\n      });\n    },\n    logoutStep,\n    // check can login normally with this password.\n    function(test, expect) {\n      Meteor.loginWithPassword({username: this.username}, this.password,\n                               loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    // plain text password. no API for this, have to invoke callLoginMethod\n    // directly.\n    function (test, expect) {\n      Accounts.callLoginMethod({\n        // wrong password\n        methodArguments: [{user: {username: this.username}, password: 'wrong'}],\n        userCallback: expect(function (error) {\n          test.isTrue(error);\n          test.isFalse(Meteor.user());\n        })});\n    },\n    function (test, expect) {\n      Accounts.callLoginMethod({\n        // right password\n        methodArguments: [{user: {username: this.username},\n                           password: this.password}],\n        userCallback: loggedInAs(this.username, test, expect)\n      });\n    },\n    logoutStep\n  ]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username\", [\n    createUserStep,\n    logoutStep,\n    // We should be able to log in with the username in lower case\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { username: \"adalovelace\" + this.randomSuffix },\n        this.password,\n        loggedInAs(this.username, test, expect));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username \" +\n      \"with non-ASCII characters\", [\n    function (test, expect) {\n      // Hack because Tinytest does not clean the database between tests/runs\n      this.randomSuffix = Random.id(10);\n      this.username = '√ÅdaL√òvelaüòàe' + this.randomSuffix;\n      this.password = 'password';\n      Accounts.createUser(\n        {username: this.username, email: this.email, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    // We should be able to log in with the username in lower case\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { username: \"√°dal√∏velaüòàe\" + this.randomSuffix },\n        this.password,\n        loggedInAs(this.username, test, expect));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username \" +\n      \"should escape regex special characters\", [\n    createUserStep,\n    logoutStep,\n    // We shouldn't be able to log in with a regex expression for the username\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { username: \".+\" + this.randomSuffix },\n        this.password,\n        expectUserNotFound(test, expect));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username \" +\n     \"should require a match of the full string\", [\n    createUserStep,\n    logoutStep,\n    // We shouldn't be able to log in with a partial match for the username\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { username: \"lovelace\" + this.randomSuffix },\n        this.password,\n        expectUserNotFound(test, expect));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive username when \" +\n      \"there are multiple matches\", [\n    createUserStep,\n    logoutStep,\n    function (test, expect) {\n      this.otherUsername = 'Adalovelace' + this.randomSuffix;\n      addSkipCaseInsensitiveChecksForTest(this.otherUsername, test, expect);\n    },\n    // Create another user with a username that only differs in case\n    function (test, expect) {\n      Accounts.createUser(\n        { username: this.otherUsername, password: this.password },\n        loggedInAs(this.otherUsername, test, expect));\n    },\n    function (test, expect) {\n      removeSkipCaseInsensitiveChecksForTest(this.otherUsername, test, expect);\n    },\n    // We shouldn't be able to log in with the username in lower case\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { username: \"adalovelace\" + this.randomSuffix },\n        this.password,\n        expectUserNotFound(test, expect));\n    },\n    // We should still be able to log in with the username in original case\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { username: this.username },\n        this.password,\n        loggedInAs(this.username, test, expect));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - creating users with the same case insensitive \" +\n      \"username\", [\n    createUserStep,\n    logoutStep,\n    // Attempting to create another user with a username that only differs in\n    // case should fail\n    function (test, expect) {\n      this.newUsername = 'adalovelace' + this.randomSuffix;\n      Accounts.createUser(\n        { username: this.newUsername, password: this.password },\n        expectError(\n          new Meteor.Error(403, \"Username already exists.\"),\n          test,\n          expect));\n    },\n    // Make sure the new user has not been inserted\n    function (test, expect) {\n      Meteor.call('countUsersOnServer',\n        { username: this.newUsername },\n        expect(function (error, result) {\n          test.equal(result, 0);\n      }));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive email\", [\n    createUserStep,\n    logoutStep,\n    // We should be able to log in with the email in lower case\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { email: \"ada-intercept@lovelace.com\" + this.randomSuffix },\n        this.password,\n        loggedInAs(this.username, test, expect));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive email should \" +\n      \"escape regex special characters\", [\n    createUserStep,\n    logoutStep,\n    // We shouldn't be able to log in with a regex expression for the email\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { email: \".+\" + this.randomSuffix },\n        this.password,\n        expectUserNotFound(test, expect));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive email should \" +\n     \"require a match of the full string\", [\n    createUserStep,\n    logoutStep,\n    // We shouldn't be able to log in with a partial match for the email\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { email: \"com\" + this.randomSuffix },\n        this.password,\n        expectUserNotFound(test, expect));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - logging in with case insensitive email when \" +\n      \"there are multiple matches\", [\n    createUserStep,\n    logoutStep,\n    function (test, expect) {\n      this.otherUsername = 'AdaLovelace' + Random.id(10);\n      this.otherEmail =  \"ADA-intercept@lovelace.com\" + this.randomSuffix;\n      addSkipCaseInsensitiveChecksForTest(this.otherEmail, test, expect);\n    },\n    // Create another user with an email that only differs in case\n    function (test, expect) {\n      Accounts.createUser(\n        { username: this.otherUsername,\n          email: this.otherEmail,\n          password: this.password },\n        loggedInAs(this.otherUsername, test, expect));\n    },\n    function (test, expect) {\n      removeSkipCaseInsensitiveChecksForTest(this.otherUsername, test, expect);\n    },\n    logoutStep,\n    // We shouldn't be able to log in with the email in lower case\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { email: \"ada-intercept@lovelace.com\" + this.randomSuffix },\n        this.password,\n        expectUserNotFound(test, expect));\n    },\n    // We should still be able to log in with the email in original case\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        { email: this.email },\n        this.password,\n        loggedInAs(this.username, test, expect));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - creating users with the same case insensitive \" +\n      \"email\", [\n    createUserStep,\n    logoutStep,\n    // Create user error without callback should throw error\n    function (test, expect) {\n      this.newUsername = 'adalovelace' + this.randomSuffix;\n      test.throws(function(){\n        Accounts.createUser({ username: this.newUsername, password: '' });\n      }, /Password may not be empty/);\n    },\n    // Attempting to create another user with an email that only differs in\n    // case should fail\n    function (test, expect) {\n      this.newEmail =  \"ada-intercept@lovelace.com\" + this.randomSuffix;\n      Accounts.createUser(\n        { email: this.newEmail, password: this.password },\n        expectError(\n          new Meteor.Error(403, \"Email already exists.\"),\n          test,\n          expect));\n    },\n    // Make sure the new user has not been inserted\n    function (test, expect) {\n      Meteor.call('countUsersOnServer',\n        { 'emails.address': this.newEmail },\n        expect (function (error, result) {\n          test.equal(result, 0);\n        })\n      );\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - changing passwords\", [\n    function (test, expect) {\n      // setup\n      this.username = Random.id();\n      this.email = Random.id() + '-intercept@example.com';\n      this.password = 'password';\n      this.password2 = 'password2';\n\n      Accounts.createUser(\n        { username: this.username, email: this.email, password: this.password },\n        loggedInAs(this.username, test, expect));\n    },\n    // Send a password reset email so that we can test that password\n    // reset tokens get deleted on password change.\n    function (test, expect) {\n      Meteor.call(\"forgotPassword\",\n        { email: this.email }, expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    function (test, expect) {\n      var self = this;\n      Meteor.call(\"getResetToken\", expect(function (err, token) {\n        test.isFalse(err);\n        test.isTrue(token);\n        self.token = token;\n      }));\n    },\n    // change password with bad old password. we stay logged in.\n    function (test, expect) {\n      var self = this;\n      Accounts.changePassword('wrong', 'doesntmatter', expect(function (error) {\n        test.isTrue(error);\n        test.equal(Meteor.user().username, self.username);\n      }));\n    },\n    // change password with blank new password\n    function (test, expect) {\n      test.throws(function(){\n        Accounts.changePassword(this.password, '');\n      }, /Password may not be empty/);\n    },\n    // change password with good old password.\n    function (test, expect) {\n      Accounts.changePassword(this.password, this.password2,\n                              loggedInAs(this.username, test, expect));\n    },\n    function (test, expect) {\n      Meteor.call(\"getResetToken\", expect(function (err, token) {\n        test.isFalse(err);\n        test.isFalse(token);\n      }));\n    },\n    logoutStep,\n    // old password, failed login\n    function (test, expect) {\n      Meteor.loginWithPassword(this.email, this.password, expect(function (error) {\n        test.isTrue(error);\n        test.isFalse(Meteor.user());\n      }));\n    },\n    // new password, success\n    function (test, expect) {\n      Meteor.loginWithPassword(this.email, this.password2,\n                               loggedInAs(this.username, test, expect));\n    },\n    logoutStep\n  ]);\n\n  testAsyncMulti(\"passwords - changing password logs out other clients\", [\n    function (test, expect) {\n      this.username = Random.id();\n      this.email = Random.id() + '-intercept@example.com';\n      this.password = 'password';\n      this.password2 = 'password2';\n      Accounts.createUser(\n        { username: this.username, email: this.email, password: this.password },\n        loggedInAs(this.username, test, expect));\n    },\n    // Log in a second connection as this user.\n    function (test, expect) {\n      var self = this;\n\n      self.secondConn = DDP.connect(Meteor.absoluteUrl());\n      self.secondConn.call('login',\n                { user: { username: self.username }, password: self.password },\n                expect(function (err, result) {\n                  test.isFalse(err);\n                  self.secondConn.setUserId(result.id);\n                  test.isTrue(self.secondConn.userId());\n\n                  self.secondConn.onReconnect = function () {\n                    self.secondConn.apply(\n                      'login',\n                      [{ resume: result.token }],\n                      { wait: true },\n                      function (err, result) {\n                        self.secondConn.setUserId(result && result.id || null);\n                      }\n                    );\n                  };\n                }));\n    },\n    function (test, expect) {\n      var self = this;\n      Accounts.changePassword(self.password, self.password2, expect(function (err) {\n        test.isFalse(err);\n      }));\n    },\n    // Now that we've changed the password, wait until the second\n    // connection gets logged out.\n    function (test, expect) {\n      var self = this;\n      pollUntil(expect, function () {\n        return self.secondConn.userId() === null;\n      }, 10 * 1000, 100);\n    }\n  ]);\n  \n  \n  testAsyncMulti(\"passwords - forgotPassword client return error when empty email\", [\n    function (test, expect) {\n      // setup\n      this.email = '';\n    },\n    // forgotPassword called on client with blank email\n    function (test, expect) {\n      Accounts.forgotPassword(\n        { email: this.email }, expect(function (error) {\n          test.isTrue(error);\n      }));\n    },\n    // forgotPassword called on client with blank email and no callback.\n    function (test, expect) {\n      test.throws(function(){\n        Accounts.forgotPassword({ email: this.email });\n      }, /Must pass options\\.email/);\n    },\n  ]);\n \n  testAsyncMulti(\"passwords - verifyEmail client return error when empty token\", [\n    function (test, expect) {\n      // setup\n      this.token = '';\n    },\n    // verifyEmail called on client with blank token\n    function (test, expect) {\n      Accounts.verifyEmail(\n        this.token, expect(function (error) {\n          test.isTrue(error);\n      }));\n    },\n    // verifyEmail called on client with blank token and no callback.\n    function (test, expect) {\n      test.throws(function(){\n        Accounts.verifyEmail(this.token);\n      }, /Need to pass token/);\n    },\n  ]);\n \n  testAsyncMulti(\"passwords - resetPassword errors\", [\n    function (test, expect) {\n      // setup\n      this.token = '';\n      this.newPassword = 'nonblankpassword';\n    },\n    // resetPassword called on client with blank token\n    function (test, expect) {\n      Accounts.resetPassword(\n        this.token, this.newPassword, expect(function (error) {\n          test.isTrue(error);\n      }));\n    },\n    function (test, expect) {\n      // setup\n      this.token = 'nonblank-token';\n      this.newPassword = '';\n    },\n    // resetPassword called on client with blank password\n    function (test, expect) {\n      Accounts.resetPassword(\n        this.token, this.newPassword, expect(function (error) {\n          test.isTrue(error);\n      }));\n    },\n    // resetPassword called on client with blank password and no callback.\n    function (test, expect) {\n      test.throws(function(){\n        Accounts.resetPassword(this.token, this.newPassword);\n      }, /Match error: Expected string, got undefined/);\n    },\n  ]);\n\n\n  testAsyncMulti(\"passwords - new user hooks\", [\n    function (test, expect) {\n      // setup\n      this.username = Random.id();\n      this.email = Random.id() + '-intercept@example.com';\n      this.password = 'password';\n    },\n    // test Accounts.validateNewUser\n    function(test, expect) {\n      Accounts.createUser(\n        {username: this.username, password: this.password,\n         // should fail the new user validators\n         profile: {invalid: true}},\n        expect(function (error) {\n          test.equal(error.error, 403);\n          test.equal(error.reason, \"User validation failed\");\n        }));\n    },\n    logoutStep,\n    function(test, expect) {\n      Accounts.createUser(\n        {username: this.username, password: this.password,\n         // should fail the new user validator with a special\n         // exception\n         profile: {invalidAndThrowException: true}},\n        expect(function (error) {\n          test.equal(\n            error.reason,\n            \"An exception thrown within Accounts.validateNewUser\");\n        }));\n    },\n    // test Accounts.onCreateUser\n    function(test, expect) {\n      Accounts.createUser(\n        {username: this.username, password: this.password,\n         testOnCreateUserHook: true},\n        loggedInAs(this.username, test, expect));\n    },\n    function(test, expect) {\n      test.equal(Meteor.user().profile.touchedByOnCreateUser, true);\n    },\n    logoutStep\n  ]);\n\n\n  testAsyncMulti(\"passwords - Meteor.user()\", [\n    function (test, expect) {\n      // setup\n      this.username = Random.id();\n      this.password = 'password';\n\n      Accounts.createUser(\n        {username: this.username, password: this.password,\n         testOnCreateUserHook: true},\n        loggedInAs(this.username, test, expect));\n    },\n    // test Meteor.user(). This test properly belongs in\n    // accounts-base/accounts_tests.js, but this is where the tests that\n    // actually log in are.\n    function(test, expect) {\n      var self = this;\n      var clientUser = Meteor.user();\n      Accounts.connection.call('testMeteorUser', expect(function (err, result) {\n        test.equal(result._id, clientUser._id);\n        test.equal(result.username, clientUser.username);\n        test.equal(result.username, self.username);\n        test.equal(result.profile.touchedByOnCreateUser, true);\n        test.equal(err, undefined);\n      }));\n    },\n    function(test, expect) {\n      // Test that even with no published fields, we still have a document.\n      Accounts.connection.call('clearUsernameAndProfile', expect(function() {\n        test.isTrue(Meteor.userId());\n        var user = Meteor.user();\n        test.equal(user, {_id: Meteor.userId()});\n      }));\n    },\n    logoutStep,\n    function(test, expect) {\n      var clientUser = Meteor.user();\n      test.equal(clientUser, null);\n      test.equal(Meteor.userId(), null);\n      Accounts.connection.call('testMeteorUser', expect(function (err, result) {\n        test.equal(err, undefined);\n        test.equal(result, null);\n      }));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - allow rules\", [\n    // create a second user to have an id for in a later test\n    function (test, expect) {\n      this.otherUsername = Random.id();\n      Accounts.createUser(\n        {username: this.otherUsername, password: 'dontcare',\n         testOnCreateUserHook: true},\n        loggedInAs(this.otherUsername, test, expect));\n    },\n    function (test, expect) {\n      this.otherUserId = Meteor.userId();\n    },\n    function (test, expect) {\n      // real setup\n      this.username = Random.id();\n      this.password = 'password';\n\n      Accounts.createUser(\n        {username: this.username, password: this.password,\n         testOnCreateUserHook: true},\n        loggedInAs(this.username, test, expect));\n    },\n    // test the default Meteor.users allow rule. This test properly belongs in\n    // accounts-base/accounts_tests.js, but this is where the tests that\n    // actually log in are.\n    function(test, expect) {\n      this.userId = Meteor.userId();\n      test.notEqual(this.userId, null);\n      test.notEqual(this.userId, this.otherUserId);\n      // Can't update fields other than profile.\n      Meteor.users.update(\n        this.userId, {$set: {disallowed: true, 'profile.updated': 42}},\n        expect(function (err) {\n          test.isTrue(err);\n          test.equal(err.error, 403);\n          test.isFalse(_.has(Meteor.user(), 'disallowed'));\n          test.isFalse(_.has(Meteor.user().profile, 'updated'));\n        }));\n    },\n    function(test, expect) {\n      // Can't update another user.\n      Meteor.users.update(\n        this.otherUserId, {$set: {'profile.updated': 42}},\n        expect(function (err) {\n          test.isTrue(err);\n          test.equal(err.error, 403);\n        }));\n    },\n    function(test, expect) {\n      // Can't update using a non-ID selector. (This one is thrown client-side.)\n      test.throws(function () {\n        Meteor.users.update(\n          {username: this.username}, {$set: {'profile.updated': 42}});\n      });\n      test.isFalse(_.has(Meteor.user().profile, 'updated'));\n    },\n    function(test, expect) {\n      // Can update own profile using ID.\n      Meteor.users.update(\n        this.userId, {$set: {'profile.updated': 42}},\n        expect(function (err) {\n          test.isFalse(err);\n          test.equal(42, Meteor.user().profile.updated);\n        }));\n    },\n    logoutStep\n  ]);\n\n\n  testAsyncMulti(\"passwords - tokens\", [\n    function (test, expect) {\n      // setup\n      this.username = Random.id();\n      this.password = 'password';\n\n      Accounts.createUser(\n        {username: this.username, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n\n    function (test, expect) {\n      // we can't login with an invalid token\n      var expectLoginError = expect(function (err) {\n        test.isTrue(err);\n      });\n      Meteor.loginWithToken('invalid', expectLoginError);\n    },\n\n    function (test, expect) {\n      // we can login with a valid token\n      var expectLoginOK = expect(function (err) {\n        test.isFalse(err);\n      });\n      Meteor.loginWithToken(Accounts._storedLoginToken(), expectLoginOK);\n    },\n\n    function (test, expect) {\n      // test logging out invalidates our token\n      var expectLoginError = expect(function (err) {\n        test.isTrue(err);\n      });\n      var token = Accounts._storedLoginToken();\n      test.isTrue(token);\n      Meteor.logout(function () {\n        Meteor.loginWithToken(token, expectLoginError);\n      });\n    },\n\n    function (test, expect) {\n      var self = this;\n      // Test that login tokens get expired. We should get logged out when a\n      // token expires, and not be able to log in again with the same token.\n      var expectNoError = expect(function (err) {\n        test.isFalse(err);\n      });\n\n      Meteor.loginWithPassword(this.username, this.password, function (error) {\n        self.token = Accounts._storedLoginToken();\n        test.isTrue(self.token);\n        expectNoError(error);\n        Accounts.connection.call(\"expireTokens\");\n      });\n    },\n    waitForLoggedOutStep,\n    function (test, expect) {\n      var token = Accounts._storedLoginToken();\n      test.isFalse(token);\n    },\n    function (test, expect) {\n      // Test that once expireTokens is finished, we can't login again with our\n      // previous token.\n      Meteor.loginWithToken(this.token, expect(function (err, result) {\n        test.isTrue(err);\n        test.equal(Meteor.userId(), null);\n      }));\n    },\n    logoutStep,\n    function (test, expect) {\n      var self = this;\n      // Test that Meteor.logoutOtherClients logs out a second\n      // authentcated connection while leaving Accounts.connection\n      // logged in.\n      var secondConn = DDP.connect(Meteor.absoluteUrl());\n      var token;\n\n      var expectSecondConnLoggedOut = expect(function (err, result) {\n        test.isTrue(err);\n      });\n\n      var expectAccountsConnLoggedIn = expect(function (err, result) {\n        test.isFalse(err);\n      });\n\n      var expectSecondConnLoggedIn = expect(function (err, result) {\n        test.equal(result.token, token);\n        test.isFalse(err);\n        Meteor.logoutOtherClients(function (err) {\n          test.isFalse(err);\n          secondConn.call('login', { resume: token },\n                          expectSecondConnLoggedOut);\n          Accounts.connection.call('login', {\n            resume: Accounts._storedLoginToken()\n          }, expectAccountsConnLoggedIn);\n        });\n      });\n\n      Meteor.loginWithPassword(\n        self.username,\n        self.password,\n        expect(function (err) {\n          test.isFalse(err);\n          token = Accounts._storedLoginToken();\n          test.isTrue(token);\n          secondConn.call('login', { resume: token },\n                          expectSecondConnLoggedIn);\n        })\n      );\n    },\n    logoutStep,\n\n    // The tests below this point are for the deprecated\n    // `logoutOtherClients` method.\n\n    function (test, expect) {\n      var self = this;\n\n      // Test that Meteor.logoutOtherClients logs out a second authenticated\n      // connection while leaving Accounts.connection logged in.\n      var token;\n      self.secondConn = DDP.connect(Meteor.absoluteUrl());\n\n      var expectLoginError = expect(function (err) {\n        test.isTrue(err);\n      });\n      var expectValidToken = expect(function (err, result) {\n        test.isFalse(err);\n        test.isTrue(result);\n        self.tokenFromLogoutOthers = result.token;\n      });\n      var expectSecondConnLoggedIn = expect(function (err, result) {\n        test.equal(result.token, token);\n        test.isFalse(err);\n        // This test will fail if an unrelated reconnect triggers before the\n        // connection is logged out. In general our tests aren't resilient to\n        // mid-test reconnects.\n        self.secondConn.onReconnect = function () {\n          self.secondConn.call(\"login\", { resume: token }, expectLoginError);\n        };\n        Accounts.connection.call(\"logoutOtherClients\", expectValidToken);\n      });\n\n      Meteor.loginWithPassword(this.username, this.password, expect(function (err) {\n        test.isFalse(err);\n        token = Accounts._storedLoginToken();\n        self.beforeLogoutOthersToken = token;\n        test.isTrue(token);\n        self.secondConn.call(\"login\", { resume: token },\n                             expectSecondConnLoggedIn);\n      }));\n    },\n    // Test that logoutOtherClients logged out Accounts.connection and that the\n    // previous token is no longer valid.\n    waitForLoggedOutStep,\n    function (test, expect) {\n      var self = this;\n      var token = Accounts._storedLoginToken();\n      test.isFalse(token);\n      this.secondConn.close();\n      Meteor.loginWithToken(\n        self.beforeLogoutOthersToken,\n        expect(function (err) {\n          test.isTrue(err);\n          test.isFalse(Meteor.userId());\n        })\n      );\n    },\n    // Test that logoutOtherClients returned a new token that we can use to\n    // log in.\n    function (test, expect) {\n      var self = this;\n      Meteor.loginWithToken(\n        self.tokenFromLogoutOthers,\n        expect(function (err) {\n          test.isFalse(err);\n          test.isTrue(Meteor.userId());\n        })\n      );\n    },\n    logoutStep,\n\n\n\n    function (test, expect) {\n      var self = this;\n      // Test that deleting a user logs out that user's connections.\n      Meteor.loginWithPassword(this.username, this.password, expect(function (err) {\n        test.isFalse(err);\n        Accounts.connection.call(\"removeUser\", self.username);\n      }));\n    },\n    waitForLoggedOutStep\n  ]);\n\n  testAsyncMulti(\"passwords - validateLoginAttempt\", [\n    function (test, expect) {\n      this.username = Random.id();\n      this.password = \"password\";\n\n      Accounts.createUser(\n        {username: this.username, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    invalidateLoginsStep,\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        this.username,\n        this.password,\n        expect(function (error) {\n          test.isTrue(error);\n          test.equal(error.reason, \"Login forbidden\");\n        })\n      );\n    },\n    validateLoginsStep,\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        \"no such user\",\n        \"some password\",\n        expect(function (error) {\n          test.isTrue(error);\n          test.equal(error.reason, 'User not found');\n        })\n      );\n    },\n    hideActualLoginErrorStep,\n    function (test, expect) {\n      Meteor.loginWithPassword(\n        \"no such user\",\n        \"some password\",\n        expect(function (error) {\n          test.isTrue(error);\n          test.equal(error.reason, 'hide actual error');\n        })\n      );\n    },\n    validateLoginsStep\n  ]);\n\n  testAsyncMulti(\"passwords - server onLogin hook\", [\n    function (test, expect) {\n      Meteor.call(\"testCaptureLogins\", expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    function (test, expect) {\n      this.username = Random.id();\n      this.password = \"password\";\n\n      Accounts.createUser(\n        {username: this.username, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n    function (test, expect) {\n      var self = this;\n      Meteor.call(\"testFetchCapturedLogins\", expect(function (error, logins) {\n        test.isFalse(error);\n        test.equal(logins.length, 1);\n        var login = logins[0];\n        test.isTrue(login.successful);\n        var attempt = login.attempt;\n        test.equal(attempt.type, \"password\");\n        test.isTrue(attempt.allowed);\n        test.equal(attempt.methodArguments[0].username, self.username);\n      }));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - client onLogin hook\", [\n    function (test, expect) {\n      var self = this;\n      this.username = Random.id();\n      this.password = \"password\";\n      this.attempt = false;\n\n      this.onLogin = Accounts.onLogin(function (attempt) {\n        self.attempt = true;\n      });\n\n      Accounts.createUser(\n        {username: this.username, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n    function (test, expect) {\n      this.onLogin.stop();\n      test.isTrue(this.attempt);\n      expect(function () {})();\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - server onLogout hook\", [\n    function (test, expect) {\n      Meteor.call(\"testCaptureLogouts\", expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    function (test, expect) {\n      this.username = Random.id();\n      this.password = \"password\";\n\n      Accounts.createUser(\n        {username: this.username, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    function (test, expect) {\n      var self = this;\n      Meteor.call(\"testFetchCapturedLogouts\", expect(function (error, logouts) {\n        test.isFalse(error);\n        test.equal(logouts.length, 1);\n        var logout = logouts[0];\n        test.isTrue(logout.successful);\n      }));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - client onLogout hook\", [\n    function (test, expect) {\n      var self = this;\n      this.username = Random.id();\n      this.password = \"password\";\n      this.attempt = false;\n\n      this.onLogout = Accounts.onLogout(function () {\n        self.logoutSuccess = true;\n      });\n\n      Accounts.createUser(\n        {username: this.username, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    function (test, expect) {\n      test.isTrue(this.logoutSuccess);\n      expect(function() {})();\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - server onLoginFailure hook\", [\n    function (test, expect) {\n      this.username = Random.id();\n      this.password = \"password\";\n\n      Accounts.createUser(\n        {username: this.username, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    function (test, expect) {\n      Meteor.call(\"testCaptureLogins\", expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    function (test, expect) {\n      Meteor.loginWithPassword(this.username, \"incorrect\", expect(function (error) {\n        test.isTrue(error);\n      }));\n    },\n    function (test, expect) {\n      Meteor.call(\"testFetchCapturedLogins\", expect(function (error, logins) {\n        test.isFalse(error);\n        test.equal(logins.length, 1);\n        var login = logins[0];\n        test.isFalse(login.successful);\n        var attempt = login.attempt;\n        test.equal(attempt.type, \"password\");\n        test.isFalse(attempt.allowed);\n        test.equal(attempt.error.reason, \"Incorrect password\");\n      }));\n    },\n    function (test, expect) {\n      Meteor.call(\"testCaptureLogins\", expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    function (test, expect) {\n      Meteor.loginWithPassword(\"no such user\", \"incorrect\", expect(function (error) {\n        test.isTrue(error);\n      }));\n    },\n    function (test, expect) {\n      Meteor.call(\"testFetchCapturedLogins\", expect(function (error, logins) {\n        test.isFalse(error);\n        test.equal(logins.length, 1);\n        var login = logins[0];\n        test.isFalse(login.successful);\n        var attempt = login.attempt;\n        test.equal(attempt.type, \"password\");\n        test.isFalse(attempt.allowed);\n        test.equal(attempt.error.reason, \"User not found\");\n      }));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - client onLoginFailure hook\", [\n    function (test, expect) {\n      var self = this;\n      this.username = Random.id();\n      this.password = \"password\";\n      this.attempt = false;\n\n      this.onLoginFailure = Accounts.onLoginFailure(function () {\n        self.attempt = true;\n      })\n\n      Accounts.createUser(\n        {username: this.username, password: this.password},\n        loggedInAs(this.username, test, expect));\n    },\n    logoutStep,\n    function (test, expect) {\n      Meteor.call(\"testCaptureLogins\", expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    function (test, expect) {\n      Meteor.loginWithPassword(this.username, \"incorrect\", expect(function (error) {\n        test.isTrue(error);\n      }));\n    },\n    function (test, expect) {\n      this.onLoginFailure.stop();\n      test.isTrue(this.attempt);\n      expect(function () {})();\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - srp to bcrypt upgrade\", [\n    logoutStep,\n    // Create user with old SRP credentials in the database.\n    function (test, expect) {\n      var self = this;\n      Meteor.call(\"testCreateSRPUser\", expect(function (error, result) {\n        test.isFalse(error);\n        self.username = result;\n      }));\n    },\n    // We are able to login with the old style credentials in the database.\n    function (test, expect) {\n      Meteor.loginWithPassword(this.username, 'abcdef', expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    function (test, expect) {\n      Meteor.call(\"testSRPUpgrade\", this.username, expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    logoutStep,\n    // After the upgrade to bcrypt we're still able to login.\n    function (test, expect) {\n      Meteor.loginWithPassword(this.username, 'abcdef', expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    logoutStep,\n    function (test, expect) {\n      Meteor.call(\"removeUser\", this.username, expect(function (error) {\n        test.isFalse(error);\n      }));\n    }\n  ]);\n\n  testAsyncMulti(\"passwords - srp to bcrypt upgrade via password change\", [\n    logoutStep,\n    // Create user with old SRP credentials in the database.\n    function (test, expect) {\n      var self = this;\n      Meteor.call(\"testCreateSRPUser\", expect(function (error, result) {\n        test.isFalse(error);\n        self.username = result;\n      }));\n    },\n    // Log in with the plaintext password handler, which should NOT upgrade us to bcrypt.\n    function (test, expect) {\n      Accounts.callLoginMethod({\n        methodName: \"login\",\n        methodArguments: [ { user: { username: this.username }, password: \"abcdef\" } ],\n        userCallback: expect(function (err) {\n          test.isFalse(err);\n        })\n      });\n    },\n    function (test, expect) {\n      Meteor.call(\"testNoSRPUpgrade\", this.username, expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    // Changing our password should upgrade us to bcrypt.\n    function (test, expect) {\n      Accounts.changePassword(\"abcdef\", \"abcdefg\", expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    function (test, expect) {\n      Meteor.call(\"testSRPUpgrade\", this.username, expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    // And after the upgrade we should be able to change our password again.\n    function (test, expect) {\n      Accounts.changePassword(\"abcdefg\", \"abcdef\", expect(function (error) {\n        test.isFalse(error);\n      }));\n    },\n    logoutStep\n  ]);\n}) ();\n\n\nif (Meteor.isServer) (function () {\n\n  Tinytest.add(\n    'passwords - setup more than one onCreateUserHook',\n    function (test) {\n      test.throws(function() {\n        Accounts.onCreateUser(function () {});\n      });\n    });\n\n\n  Tinytest.add(\n    'passwords - createUser hooks',\n    function (test) {\n      var username = Random.id();\n      test.throws(function () {\n        // should fail the new user validators\n        Accounts.createUser({username: username, profile: {invalid: true}});\n      });\n\n      var userId = Accounts.createUser({username: username,\n                                        testOnCreateUserHook: true});\n\n      test.isTrue(userId);\n      var user = Meteor.users.findOne(userId);\n      test.equal(user.profile.touchedByOnCreateUser, true);\n    });\n\n\n  Tinytest.add(\n    'passwords - setPassword',\n    function (test) {\n      var username = Random.id();\n      var email = username + '-intercept@example.com';\n\n      var userId = Accounts.createUser({username: username, email: email});\n\n      var user = Meteor.users.findOne(userId);\n      // no services yet.\n      test.equal(user.services.password, undefined);\n\n      // set a new password.\n      Accounts.setPassword(userId, 'new password');\n      user = Meteor.users.findOne(userId);\n      var oldSaltedHash = user.services.password.bcrypt;\n      test.isTrue(oldSaltedHash);\n\n      // Send a reset password email (setting a reset token) and insert a login\n      // token.\n      Accounts.sendResetPasswordEmail(userId, email);\n      Accounts._insertLoginToken(userId, Accounts._generateStampedLoginToken());\n      test.isTrue(Meteor.users.findOne(userId).services.password.reset);\n      test.isTrue(Meteor.users.findOne(userId).services.resume.loginTokens);\n\n      // reset with the same password, see we get a different salted hash\n      Accounts.setPassword(userId, 'new password', {logout: false});\n      user = Meteor.users.findOne(userId);\n      var newSaltedHash = user.services.password.bcrypt;\n      test.isTrue(newSaltedHash);\n      test.notEqual(oldSaltedHash, newSaltedHash);\n      // No more reset token.\n      test.isFalse(Meteor.users.findOne(userId).services.password.reset);\n      // But loginTokens are still here since we did logout: false.\n      test.isTrue(Meteor.users.findOne(userId).services.resume.loginTokens);\n\n      // reset again, see that the login tokens are gone.\n      Accounts.setPassword(userId, 'new password');\n      user = Meteor.users.findOne(userId);\n      var newerSaltedHash = user.services.password.bcrypt;\n      test.isTrue(newerSaltedHash);\n      test.notEqual(oldSaltedHash, newerSaltedHash);\n      test.notEqual(newSaltedHash, newerSaltedHash);\n      // No more tokens.\n      test.isFalse(Meteor.users.findOne(userId).services.password.reset);\n      test.isFalse(Meteor.users.findOne(userId).services.resume.loginTokens);\n\n      // cleanup\n      Meteor.users.remove(userId);\n    });\n\n\n  // This test properly belongs in accounts-base/accounts_tests.js, but\n  // this is where the tests that actually log in are.\n  Tinytest.add('accounts - user() out of context', function (test) {\n    // basic server context, no method.\n    test.throws(function () {\n      Meteor.user();\n    });\n  });\n\n  // XXX would be nice to test\n  // Accounts.config({forbidClientAccountCreation: true})\n\n  Tinytest.addAsync(\n    'passwords - login token observes get cleaned up',\n    function (test, onComplete) {\n      var username = Random.id();\n      Accounts.createUser({\n        username: username,\n        password: 'password'\n      });\n\n      makeTestConnection(\n        test,\n        function (clientConn, serverConn) {\n          serverConn.onClose(function () {\n            test.isFalse(Accounts._getUserObserve(serverConn.id));\n            onComplete();\n          });\n          var result = clientConn.call('login', {\n            user: {username: username},\n            password: 'password'\n          });\n          test.isTrue(result);\n          var token = Accounts._getAccountData(serverConn.id, 'loginToken');\n          test.isTrue(token);\n\n          // We poll here, instead of just checking `_getUserObserve`\n          // once, because the login method defers the creation of the\n          // observe, and setting up the observe yields, so we could end\n          // up here before the observe has been set up.\n          simplePoll(\n            function () {\n              return !! Accounts._getUserObserve(serverConn.id);\n            },\n            function () {\n              test.isTrue(Accounts._getUserObserve(serverConn.id));\n              clientConn.disconnect();\n            },\n            function () {\n              test.fail(\"timed out waiting for user observe for connection \" +\n                        serverConn.id);\n              onComplete();\n            }\n          );\n        },\n        onComplete\n      );\n    }\n  );\n\n  Tinytest.add(\n    'passwords - reset password doesn\\t work if email changed after email sent',\n    function (test) {\n      var username = Random.id();\n      var email = username + '-intercept@example.com';\n\n      var userId = Accounts.createUser({\n        username: username,\n        email: email,\n        password: \"old-password\"\n      });\n\n      var user = Meteor.users.findOne(userId);\n\n      Accounts.sendResetPasswordEmail(userId, email);\n\n      var resetPasswordEmailOptions =\n        Meteor.call(\"getInterceptedEmails\", email)[0];\n\n      var re = new RegExp(Meteor.absoluteUrl() + \"#/reset-password/(\\\\S*)\");\n      var match = resetPasswordEmailOptions.text.match(re);\n      test.isTrue(match);\n      var resetPasswordToken = match[1];\n\n      var newEmail = Random.id() + '-new@example.com';\n      Meteor.users.update(userId, {$set: {\"emails.0.address\": newEmail}});\n\n      test.throws(function () {\n        Meteor.call(\"resetPassword\", resetPasswordToken, \"new-password\");\n      }, /Token has invalid email address/);\n      test.throws(function () {\n        Meteor.call(\"login\", {user: {username: username}, password: \"new-password\"});\n      }, /Incorrect password/);\n    });\n\n  Tinytest.addAsync(\n    'passwords - reset password should work when token is not expired',\n    function (test, onComplete) {\n      var username = Random.id();\n      var email = username + '-intercept@example.com';\n\n      var userId = Accounts.createUser({\n        username: username,\n        email: email,\n        password: \"old-password\"\n      });\n\n      var user = Meteor.users.findOne(userId);\n\n      Accounts.sendResetPasswordEmail(userId, email);\n\n      var resetPasswordEmailOptions =\n        Meteor.call(\"getInterceptedEmails\", email)[0];\n\n      var re = new RegExp(Meteor.absoluteUrl() + \"#/reset-password/(\\\\S*)\");\n      var match = resetPasswordEmailOptions.text.match(re);\n      test.isTrue(match);\n      var resetPasswordToken = match[1];\n\n      makeTestConnection(\n        test,\n        function (clientConn) {\n          test.isTrue(clientConn.call(\n            \"resetPassword\",\n            resetPasswordToken,\n            \"new-password\"\n          ));\n\n          test.isTrue(clientConn.call(\"login\", {\n            user: { username },\n            password: \"new-password\"\n          }));\n\n          onComplete();\n      });\n    });\n\n  Tinytest.add(\n    'passwords - reset password should not work when token is expired',\n    function (test) {\n      var username = Random.id();\n      var email = username + '-intercept@example.com';\n\n      var userId = Accounts.createUser({\n        username: username,\n        email: email,\n        password: \"old-password\"\n      });\n\n      var user = Meteor.users.findOne(userId);\n\n      Accounts.sendResetPasswordEmail(userId, email);\n\n      var resetPasswordEmailOptions =\n        Meteor.call(\"getInterceptedEmails\", email)[0];\n\n      var re = new RegExp(Meteor.absoluteUrl() + \"#/reset-password/(\\\\S*)\");\n      var match = resetPasswordEmailOptions.text.match(re);\n      test.isTrue(match);\n      var resetPasswordToken = match[1];\n\n      Meteor.users.update(userId, {$set: {\"services.password.reset.when\":  new Date(Date.now() + -5 * 24 * 3600 * 1000) }});\n\n      test.throws(function () {\n        Meteor.call(\"resetPassword\", resetPasswordToken, \"new-password\");\n      }, /Token expired/);\n      test.throws(function () {\n        Meteor.call(\"login\", {user: {username: username}, password: \"new-password\"});\n      }, /Incorrect password/);\n    });\n\n  Tinytest.add(\n    'passwords - reset tokens with reasons get cleaned up',\n    function (test) {\n      var email = test.id + '-intercept@example.com';\n      var userId = Accounts.createUser({email: email, password: 'password'});\n      Accounts.sendResetPasswordEmail(userId, email);\n      test.isTrue(!!Meteor.users.findOne(userId).services.password.reset);\n\n      Accounts._expirePasswordResetTokens(new Date(), userId);\n\n      test.isUndefined(Meteor.users.findOne(userId).services.password.reset);\n    });\n\n  Tinytest.add(\n    'passwords - reset tokens without reasons get cleaned up',\n    function (test) {\n      var email = test.id + '-intercept@example.com';\n      var userId = Accounts.createUser({email: email, password: 'password'});\n      Accounts.sendResetPasswordEmail(userId, email);\n      Meteor.users.update({_id: userId}, {$unset: {\"services.password.reset.reason\": 1}});\n      test.isTrue(!!Meteor.users.findOne(userId).services.password.reset);\n      test.isUndefined(Meteor.users.findOne(userId).services.password.reset.reason);\n\n      Accounts._expirePasswordResetTokens(new Date(), userId);\n\n      test.isUndefined(Meteor.users.findOne(userId).services.password.reset);\n    });\n\n  Tinytest.addAsync(\n    'passwords - enroll password should work when token is not expired',\n    function (test, onComplete) {\n      var username = Random.id();\n      var email = username + '-intercept@example.com';\n\n      var userId = Accounts.createUser({\n        username: username,\n        email: email\n      });\n\n      var user = Meteor.users.findOne(userId);\n\n      Accounts.sendEnrollmentEmail(userId, email);\n\n      var enrollPasswordEmailOptions =\n        Meteor.call(\"getInterceptedEmails\", email)[0];\n\n      var re = new RegExp(Meteor.absoluteUrl() + \"#/enroll-account/(\\\\S*)\");\n      var match = enrollPasswordEmailOptions.text.match(re);\n      test.isTrue(match);\n      var enrollPasswordToken = match[1];\n\n      makeTestConnection(\n        test,\n        function (clientConn) {\n          test.isTrue(clientConn.call(\n            \"resetPassword\",\n            enrollPasswordToken,\n            \"new-password\"\n          ));\n\n          test.isTrue(clientConn.call(\"login\", {\n            user: { username },\n            password: \"new-password\"\n          }));\n\n          onComplete();\n        });\n    });\n\n  Tinytest.add(\n    'passwords - enroll password should not work when token is expired',\n    function (test) {\n      var username = Random.id();\n      var email = username + '-intercept@example.com';\n\n      var userId = Accounts.createUser({\n        username: username,\n        email: email\n      });\n\n      var user = Meteor.users.findOne(userId);\n\n      Accounts.sendEnrollmentEmail(userId, email);\n\n      var enrollPasswordEmailOptions =\n        Meteor.call(\"getInterceptedEmails\", email)[0];\n\n      var re = new RegExp(Meteor.absoluteUrl() + \"#/enroll-account/(\\\\S*)\");\n      var match = enrollPasswordEmailOptions.text.match(re);\n      test.isTrue(match);\n      var enrollPasswordToken = match[1];\n\n      Meteor.users.update(userId, {$set: {\"services.password.reset.when\":  new Date(Date.now() + -35 * 24 * 3600 * 1000) }});\n\n      test.throws(function () {\n        Meteor.call(\"resetPassword\", enrollPasswordToken, \"new-password\");\n      }, /Token expired/);\n    });\n\n  Tinytest.add(\n    'passwords - enroll tokens get cleaned up',\n    function (test) {\n      var email = test.id + '-intercept@example.com';\n      var userId = Accounts.createUser({email: email, password: 'password'});\n      Accounts.sendEnrollmentEmail(userId, email);\n      test.isTrue(!!Meteor.users.findOne(userId).services.password.reset);\n\n      Accounts._expirePasswordEnrollTokens(new Date(), userId);\n\n      test.isUndefined(Meteor.users.findOne(userId).services.password.reset);\n    }\n  )\n\n  // We should be able to change the username\n  Tinytest.add(\"passwords - change username\", function (test) {\n    var username = Random.id();\n    var userId = Accounts.createUser({\n      username: username\n    });\n\n    test.isTrue(userId);\n\n    var newUsername = Random.id();\n    Accounts.setUsername(userId, newUsername);\n\n    test.equal(Accounts._findUserByQuery({id: userId}).username, newUsername);\n\n    // Test findUserByUsername as well while we're here\n    test.equal(Accounts.findUserByUsername(newUsername)._id, userId);\n  });\n\n  Tinytest.add(\"passwords - change username to a new one only differing \" +\n      \"in case\", function (test) {\n    var username = Random.id() + \"user\";\n    var userId = Accounts.createUser({\n      username: username.toUpperCase()\n    });\n\n    test.isTrue(userId);\n\n    var newUsername = username.toLowerCase();\n    Accounts.setUsername(userId, newUsername);\n\n    test.equal(Accounts._findUserByQuery({id: userId}).username, newUsername);\n  });\n\n  // We should not be able to change the username to one that only\n  // differs in case from an existing one\n  Tinytest.add(\"passwords - change username should fail when there are \" +\n      \"existing users with a username only differing in case\", function (test) {\n    var username = Random.id() + \"user\";\n    var usernameUpper = username.toUpperCase();\n\n    var userId1 = Accounts.createUser({\n      username: username\n    });\n\n    var user2OriginalUsername = Random.id();\n    var userId2 = Accounts.createUser({\n      username: user2OriginalUsername\n    });\n\n    test.isTrue(userId1);\n    test.isTrue(userId2);\n\n    test.throws(function () {\n      Accounts.setUsername(userId2, usernameUpper);\n    }, /Username already exists/);\n\n    test.equal(Accounts._findUserByQuery({id: userId2}).username,\n      user2OriginalUsername);\n  });\n\n  Tinytest.add(\"passwords - add email\", function (test) {\n    var origEmail = Random.id() + \"@turing.com\";\n    var userId = Accounts.createUser({\n      email: origEmail\n    });\n\n    var newEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, newEmail);\n\n    var thirdEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, thirdEmail, true);\n\n    test.equal(Accounts._findUserByQuery({id: userId}).emails, [\n      { address: origEmail, verified: false },\n      { address: newEmail, verified: false },\n      { address: thirdEmail, verified: true }\n    ]);\n\n    // Test findUserByEmail as well while we're here\n    test.equal(Accounts.findUserByEmail(origEmail)._id, userId);\n  });\n\n  Tinytest.add(\"passwords - add email when the user has an existing email \" +\n      \"only differing in case\", function (test) {\n    var origEmail = Random.id() + \"@turing.com\";\n    var userId = Accounts.createUser({\n      email: origEmail\n    });\n\n    var newEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, newEmail);\n\n    var thirdEmail = origEmail.toUpperCase();\n    Accounts.addEmail(userId, thirdEmail, true);\n\n    test.equal(Accounts._findUserByQuery({id: userId}).emails, [\n      { address: thirdEmail, verified: true },\n      { address: newEmail, verified: false }\n    ]);\n  });\n\n  Tinytest.add(\"passwords - add email should fail when there is an existing \" +\n      \"user with an email only differing in case\", function (test) {\n    var user1Email = Random.id() + \"@turing.com\";\n    var userId1 = Accounts.createUser({\n      email: user1Email\n    });\n\n    var user2Email = Random.id() + \"@turing.com\";\n    var userId2 = Accounts.createUser({\n      email: user2Email\n    });\n\n    var dupEmail = user1Email.toUpperCase();\n    test.throws(function () {\n      Accounts.addEmail(userId2, dupEmail);\n    }, /Email already exists/);\n\n    test.equal(Accounts._findUserByQuery({id: userId1}).emails, [\n      { address: user1Email, verified: false }\n    ]);\n\n    test.equal(Accounts._findUserByQuery({id: userId2}).emails, [\n      { address: user2Email, verified: false }\n    ]);\n  });\n\n  Tinytest.add(\"passwords - remove email\", function (test) {\n    var origEmail = Random.id() + \"@turing.com\";\n    var userId = Accounts.createUser({\n      email: origEmail\n    });\n\n    var newEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, newEmail);\n\n    var thirdEmail = Random.id() + \"@turing.com\";\n    Accounts.addEmail(userId, thirdEmail, true);\n\n    test.equal(Accounts._findUserByQuery({id: userId}).emails, [\n      { address: origEmail, verified: false },\n      { address: newEmail, verified: false },\n      { address: thirdEmail, verified: true }\n    ]);\n\n    Accounts.removeEmail(userId, newEmail);\n\n    test.equal(Accounts._findUserByQuery({id: userId}).emails, [\n      { address: origEmail, verified: false },\n      { address: thirdEmail, verified: true }\n    ]);\n\n    Accounts.removeEmail(userId, origEmail);\n\n    test.equal(Accounts._findUserByQuery({id: userId}).emails, [\n      { address: thirdEmail, verified: true }\n    ]);\n  });\n\n}) ();\n"]},"hash":"fad0d3ea4beddfb20e257d338af5c67e91a666fd"}
